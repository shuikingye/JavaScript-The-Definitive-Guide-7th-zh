name: Generate PDF with Python and WeasyPrint

on:
  push:
    branches: [main, master]
  workflow_dispatch:

jobs:
  generate-pdf:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout Code
      uses: actions/checkout@v4

    - name: Setup Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'

    - name: Install Dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          pandoc \
          fonts-noto-cjk \
          fonts-noto-color-emoji
        pip install weasyprint markdown

    - name: Create Directories
      run: |
        echo "ğŸ“ åˆ›å»ºå¿…è¦çš„ç›®å½•..."
        mkdir -p _temp _output
        echo "ç›®å½•åˆ›å»ºå®Œæˆ:"
        ls -la

    - name: Create Combined Markdown File
      run: |
        echo "ğŸ“ åˆ›å»ºåˆå¹¶çš„ Markdown æ–‡ä»¶..."
        
        # ç¡®ä¿ç›®å½•å­˜åœ¨
        mkdir -p _temp _output
        
        # åˆ›å»ºåˆå¹¶æ–‡ä»¶
        {
          echo "# JavaScriptæƒå¨æŒ‡å—ç¬¬ä¸ƒç‰ˆ"
          echo ""
          echo "**ä½œè€…: Richard-Billyham**"
          echo ""
          echo "---"
          echo ""
        } > _temp/combined.md
        
        # æ·»åŠ  README
        if [ -f "README.md" ]; then
          echo "æ·»åŠ  README.md"
          cat "README.md" >> _temp/combined.md
          echo "" >> _temp/combined.md
          echo "---" >> _temp/combined.md
          echo "" >> _temp/combined.md
        else
          echo "âš ï¸ README.md ä¸å­˜åœ¨"
        fi
        
        # æŒ‰é¡ºåºæ·»åŠ ç« èŠ‚
        for i in {1..17}; do
          chapter_file="./docs/ch${i}.md"
          if [ -f "$chapter_file" ]; then
            echo "æ·»åŠ ç« èŠ‚: $chapter_file"
            echo "# ç¬¬${i}ç« " >> _temp/combined.md
            echo "" >> _temp/combined.md
            cat "$chapter_file" >> _temp/combined.md
            echo "" >> _temp/combined.md
            echo "---" >> _temp/combined.md
            echo "" >> _temp/combined.md
          else
            echo "âš ï¸ ç« èŠ‚ä¸å­˜åœ¨: $chapter_file"
          fi
        done
        
        echo "âœ… åˆå¹¶æ–‡ä»¶åˆ›å»ºå®Œæˆ"
        echo "æ–‡ä»¶å¤§å°: $(ls -lh _temp/combined.md)"
        echo "æ–‡ä»¶è¡Œæ•°: $(wc -l < _temp/combined.md)"

    - name: Convert Markdown to HTML
      run: |
        echo "ğŸ¯ å°† Markdown è½¬æ¢ä¸º HTML..."
        
        # æ£€æŸ¥æ–‡ä»¶æ˜¯å¦å­˜åœ¨
        if [ ! -f "_temp/combined.md" ]; then
          echo "âŒ _temp/combined.md ä¸å­˜åœ¨"
          exit 1
        fi
        
        # ä½¿ç”¨ Pandoc è½¬æ¢ä¸º HTML
        pandoc "_temp/combined.md" -o "_temp/document.html" \
          --toc \
          --toc-depth=3 \
          --self-contained \
          --css=https://cdnjs.cloudflare.com/ajax/libs/github-markdown-css/5.1.0/github-markdown.min.css \
          -M title="JavaScriptæƒå¨æŒ‡å—ç¬¬ä¸ƒç‰ˆ" \
          -M author="Richard-Billyham" \
          -M date="$(date +%Y-%m-%d)" \
          --metadata lang=zh-CN
        
        echo "âœ… HTML æ–‡æ¡£åˆ›å»ºå®Œæˆ"
        echo "HTML æ–‡ä»¶å¤§å°: $(ls -lh _temp/document.html)"

    - name: Create Custom CSS
      run: |
        echo "ğŸ¨ åˆ›å»ºè‡ªå®šä¹‰ CSS..."
        
        cat > _temp/custom.css << 'EOF'
        @page {
          size: A4;
          margin: 2.5cm;
          @bottom-center {
            content: "ç¬¬ " counter(page) " é¡µ";
            font-family: "Noto Sans CJK SC", sans-serif;
            font-size: 10pt;
          }
        }
        
        body {
          font-family: "Noto Sans CJK SC", "Source Han Sans CN", sans-serif;
          font-size: 12pt;
          line-height: 1.6;
          color: #333;
        }
        
        .markdown-body {
          font-family: "Noto Sans CJK SC", "Source Han Sans CN", sans-serif;
          font-size: 12pt;
          line-height: 1.6;
          max-width: none;
          margin: 0;
          padding: 0;
        }
        
        h1, h2, h3, h4, h5, h6 {
          font-family: "Noto Sans CJK SC", "Source Han Sans CN", sans-serif;
          color: #2c3e50;
          page-break-after: avoid;
        }
        
        h1 {
          font-size: 24pt;
          border-bottom: 2px solid #3498db;
          padding-bottom: 0.3em;
        }
        
        h2 {
          font-size: 20pt;
          border-bottom: 1px solid #ecf0f1;
          padding-bottom: 0.3em;
        }
        
        code {
          font-family: "Noto Sans Mono CJK SC", monospace;
          background-color: #f8f9fa;
          padding: 0.2em 0.4em;
          border-radius: 3px;
          font-size: 11pt;
        }
        
        pre {
          background-color: #f8f9fa;
          border: 1px solid #e1e4e8;
          border-radius: 6px;
          padding: 16px;
          overflow: auto;
          font-size: 11pt;
          page-break-inside: avoid;
        }
        
        pre code {
          background: none;
          padding: 0;
        }
        
        table {
          border-collapse: collapse;
          width: 100%;
          margin: 1em 0;
          page-break-inside: avoid;
        }
        
        th, td {
          border: 1px solid #dfe2e5;
          padding: 6px 13px;
          text-align: left;
        }
        
        th {
          background-color: #f6f8fa;
          font-weight: 600;
        }
        
        blockquote {
          border-left: 4px solid #dfe2e5;
          margin: 1em 0;
          padding: 0 1em;
          color: #6a737d;
          background-color: #fafbfc;
        }
        
        a {
          color: #0366d6;
          text-decoration: none;
        }
        
        a:hover {
          text-decoration: underline;
        }
        
        /* ç›®å½•æ ·å¼ */
        #TOC {
          background: #f8f9fa;
          border: 1px solid #e1e4e8;
          border-radius: 6px;
          padding: 1em;
          margin-bottom: 2em;
        }
        
        #TOC ul {
          list-style-type: none;
          padding-left: 1em;
        }
        
        #TOC > ul {
          padding-left: 0;
        }
        
        #TOC li {
          margin: 0.5em 0;
        }
        
        #TOC a {
          color: #0366d6;
        }
        
        /* é¿å…åœ¨æ ‡é¢˜å‰åˆ†é¡µ */
        h1, h2, h3 {
          page-break-before: avoid;
        }
        
        /* ç¡®ä¿ä»£ç å—ä¸è¢«åˆ†å‰² */
        pre {
          page-break-inside: avoid;
        }
        
        /* å›¾ç‰‡å¤„ç† */
        img {
          max-width: 100%;
          height: auto;
          page-break-inside: avoid;
        }
        EOF
        
        echo "âœ… è‡ªå®šä¹‰ CSS åˆ›å»ºå®Œæˆ"

    - name: Convert HTML to PDF with WeasyPrint
      run: |
        echo "ğŸ¯ ä½¿ç”¨ WeasyPrint ç”Ÿæˆ PDF..."
        
        # æ£€æŸ¥ HTML æ–‡ä»¶æ˜¯å¦å­˜åœ¨
        if [ ! -f "_temp/document.html" ]; then
          echo "âŒ _temp/document.html ä¸å­˜åœ¨"
          exit 1
        fi
        
        # ä½¿ç”¨ WeasyPrint ç”Ÿæˆ PDF
        weasyprint _temp/document.html _output/javascript-guide.pdf \
          -s _temp/custom.css \
          --presentational-hints
        
        echo "âœ… WeasyPrint PDF ç”Ÿæˆå®Œæˆ"
        echo "PDF æ–‡ä»¶å¤§å°: $(ls -lh _output/javascript-guide.pdf)"

    - name: Verify PDF Generation
      run: |
        echo "ğŸ“Š éªŒè¯ PDF ç”Ÿæˆ..."
        
        if [ ! -f "_output/javascript-guide.pdf" ]; then
          echo "âŒ PDF æ–‡ä»¶æœªç”Ÿæˆ"
          exit 1
        fi
        
        PDF_SIZE=$(stat -c%s "_output/javascript-guide.pdf")
        echo "PDF æ–‡ä»¶å¤§å°: $PDF_SIZE å­—èŠ‚ ($(echo "scale=2; $PDF_SIZE/1024/1024" | bc) MB)"
        
        if [ "$PDF_SIZE" -lt 102400 ]; then
          echo "âš ï¸ è­¦å‘Š: PDF æ–‡ä»¶å¯èƒ½å¤ªå°"
        else
          echo "âœ… PDF æ–‡ä»¶å¤§å°æ­£å¸¸"
        fi

    - name: Upload PDF Artifact
      uses: actions/upload-artifact@v4
      with:
        name: JavaScript-Guide-PDF
        path: _output/javascript-guide.pdf
        retention-days: 30

    - name: Upload Debug Files
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: Debug-Files
        path: |
          _temp/combined.md
          _temp/document.html
          _temp/custom.css
        retention-days: 7
