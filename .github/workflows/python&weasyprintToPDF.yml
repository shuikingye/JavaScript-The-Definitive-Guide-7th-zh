name: Generate PDF with Enhanced Styling

on:
  push:
    branches: [main, master]
  workflow_dispatch:

jobs:
  generate-pdf:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout Code
      uses: actions/checkout@v4

    - name: Setup Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'

    - name: Install Dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          pandoc \
          fonts-noto-cjk \
          fonts-noto-color-emoji \
          fonts-noto-mono
        pip install weasyprint markdown

    - name: Create Directories
      run: |
        mkdir -p _temp _output

    - name: Create Combined Markdown File
      run: |
        echo "ğŸ“ åˆ›å»ºåˆå¹¶çš„ Markdown æ–‡ä»¶..."
        
        # åˆ›å»ºå°é¢å’Œç›®å½•ç»“æ„
        cat > _temp/combined.md << 'EOF'
        ---
        title: "JavaScriptæƒå¨æŒ‡å—ç¬¬ä¸ƒç‰ˆ"
        author: "Richard-Billyham"
        date: "$(date +%Yå¹´%mæœˆ%dæ—¥)"
        ---
        
        # JavaScriptæƒå¨æŒ‡å—ç¬¬ä¸ƒç‰ˆ
        
        <div style="text-align: center; margin: 5cm 0;">
          <h1 style="font-size: 28pt; margin-bottom: 1cm;">JavaScriptæƒå¨æŒ‡å—ç¬¬ä¸ƒç‰ˆ</h1>
          <h2 style="font-size: 18pt; color: #666; margin-bottom: 2cm;">JavaScript: The Definitive Guide, 7th Edition</h2>
          <p style="font-size: 14pt;">ä½œè€…: Richard-Billyham</p>
          <p style="font-size: 12pt; color: #999;">ç”Ÿæˆæ—¶é—´: $(date +%Yå¹´%mæœˆ%dæ—¥)</p>
        </div>
        
        \newpage
        
        ## ç›®å½•
        
        <!-- ç›®å½•å°†ç”± Pandoc è‡ªåŠ¨ç”Ÿæˆ -->
        
        \newpage
        
        EOF
        
        # æ·»åŠ  README ä½œä¸ºç®€ä»‹
        if [ -f "README.md" ]; then
          echo "# ç®€ä»‹" >> _temp/combined.md
          echo "" >> _temp/combined.md
          cat "README.md" >> _temp/combined.md
          echo "" >> _temp/combined.md
          echo "\newpage" >> _temp/combined.md
          echo "" >> _temp/combined.md
        fi
        
        # æŒ‰é¡ºåºæ·»åŠ ç« èŠ‚
        for i in {1..17}; do
          chapter_file="./docs/ch${i}.md"
          if [ -f "$chapter_file" ]; then
            echo "æ·»åŠ ç« èŠ‚: $chapter_file"
            # æå–åŸå§‹æ ‡é¢˜æˆ–ä½¿ç”¨é»˜è®¤æ ‡é¢˜
            original_title=$(head -n 1 "$chapter_file" | sed -E 's/^#+ //' | head -1)
            if [ -n "$original_title" ] && [ "$original_title" != "" ]; then
              title="$original_title"
            else
              title="ç¬¬${i}ç« "
            fi
            
            echo "# $title" >> _temp/combined.md
            echo "" >> _temp/combined.md
            
            # è·³è¿‡åŸæ–‡ä»¶çš„ç¬¬ä¸€è¡Œï¼ˆæ ‡é¢˜ï¼‰
            tail -n +2 "$chapter_file" >> _temp/combined.md
            
            echo "" >> _temp/combined.md
            echo "\newpage" >> _temp/combined.md
            echo "" >> _temp/combined.md
          fi
        done
        
        echo "âœ… åˆå¹¶æ–‡ä»¶åˆ›å»ºå®Œæˆ"
        echo "æ–‡ä»¶å¤§å°: $(ls -lh _temp/combined.md)"

    - name: Convert Markdown to HTML with Enhanced Template
      run: |
        echo "ğŸ¯ ä½¿ç”¨å¢å¼ºæ¨¡æ¿è½¬æ¢ä¸º HTML..."
        
        # åˆ›å»ºè‡ªå®šä¹‰ HTML æ¨¡æ¿
        cat > _temp/template.html << 'EOF'
        <!DOCTYPE html>
        <html lang="zh-CN">
        <head>
            <meta charset="utf-8">
            <title>$title$</title>
            <meta name="author" content="$author$">
            <style>
                /* åŸºç¡€æ ·å¼å°†åœ¨åé¢çš„CSSæ–‡ä»¶ä¸­å®šä¹‰ */
            </style>
        </head>
        <body>
            <div class="book">
                $if(title)$
                <header class="cover">
                    <h1 class="title">$title$</h1>
                    $if(author)$
                    <p class="author">$author$</p>
                    $endif$
                    $if(date)$
                    <p class="date">$date$</p>
                    $endif$
                </header>
                $endif$
                
                $if(toc)$
                <nav class="toc">
                    <h2>ç›®å½•</h2>
                    $toc$
                </nav>
                $endif$
                
                <main class="content">
                    $body$
                </main>
            </div>
        </body>
        </html>
        EOF
        
        # è½¬æ¢ä¸º HTML
        pandoc "_temp/combined.md" -o "_temp/document.html" \
          --template="_temp/template.html" \
          --toc \
          --toc-depth=3 \
          --self-contained \
          -M title="JavaScriptæƒå¨æŒ‡å—ç¬¬ä¸ƒç‰ˆ" \
          -M author="Richard-Billyham" \
          --metadata lang=zh-CN \
          --css=https://cdnjs.cloudflare.com/ajax/libs/github-markdown-css/5.1.0/github-markdown.min.css
        
        echo "âœ… HTML è½¬æ¢å®Œæˆ"

    - name: Create Enhanced CSS Styling
      run: |
        echo "ğŸ¨ åˆ›å»ºå¢å¼ºçš„ CSS æ ·å¼..."
        
        cat > _temp/enhanced.css << 'EOF'
        @import url('https://cdnjs.cloudflare.com/ajax/libs/github-markdown-css/5.1.0/github-markdown.min.css');
        
        @page {
          size: A4;
          margin: 2cm;
          
          @top-left {
            content: "JavaScriptæƒå¨æŒ‡å—ç¬¬ä¸ƒç‰ˆ";
            font-family: "Noto Sans CJK SC", sans-serif;
            font-size: 9pt;
            color: #666;
          }
          
          @top-right {
            content: counter(page);
            font-family: "Noto Sans CJK SC", sans-serif;
            font-size: 9pt;
          }
          
          @bottom-center {
            content: "--- ç¬¬ " counter(page) " é¡µ ---";
            font-family: "Noto Sans CJK SC", sans-serif;
            font-size: 8pt;
            color: #999;
          }
        }
        
        @page :first {
          @top-left { content: none; }
          @top-right { content: none; }
          @bottom-center { content: none; }
          margin: 0;
        }
        
        @page toc {
          @top-left { content: "ç›®å½•"; }
        }
        
        /* åŸºç¡€æ ·å¼ */
        body {
          font-family: "Noto Sans CJK SC", "Source Han Sans CN", "PingFang SC", "Microsoft YaHei", sans-serif;
          font-size: 11pt;
          line-height: 1.6;
          color: #333;
          margin: 0;
          padding: 0;
        }
        
        /* å°é¢æ ·å¼ */
        .cover {
          height: 100vh;
          display: flex;
          flex-direction: column;
          justify-content: center;
          align-items: center;
          text-align: center;
          page-break-after: always;
        }
        
        .cover .title {
          font-size: 28pt;
          font-weight: bold;
          color: #2c3e50;
          margin-bottom: 1cm;
          border-bottom: 3px solid #3498db;
          padding-bottom: 0.5cm;
        }
        
        .cover .subtitle {
          font-size: 16pt;
          color: #7f8c8d;
          margin-bottom: 2cm;
          font-weight: normal;
        }
        
        .cover .author {
          font-size: 14pt;
          color: #34495e;
          margin-bottom: 0.5cm;
        }
        
        .cover .date {
          font-size: 11pt;
          color: #95a5a6;
        }
        
        /* ç›®å½•æ ·å¼ */
        .toc {
          page-break-after: always;
        }
        
        .toc h2 {
          text-align: center;
          font-size: 20pt;
          color: #2c3e50;
          margin-bottom: 1cm;
          border-bottom: 2px solid #3498db;
          padding-bottom: 0.3cm;
        }
        
        #TOC {
          background: #f8f9fa;
          border: 1px solid #e1e4e8;
          border-radius: 8px;
          padding: 1.5cm;
          margin: 1cm 0;
        }
        
        #TOC ul {
          list-style-type: none;
          padding-left: 0;
        }
        
        #TOC > ul > li {
          margin: 0.7em 0;
          font-weight: bold;
        }
        
        #TOC > ul > li > a {
          color: #2c3e50;
          text-decoration: none;
          font-size: 12pt;
        }
        
        #TOC ul ul {
          padding-left: 1.5em;
          margin: 0.3em 0;
        }
        
        #TOC ul ul li {
          margin: 0.4em 0;
          font-weight: normal;
        }
        
        #TOC ul ul li a {
          color: #34495e;
          text-decoration: none;
          font-size: 11pt;
        }
        
        #TOC a:hover {
          text-decoration: underline;
          color: #3498db;
        }
        
        /* å†…å®¹åŒºåŸŸæ ·å¼ */
        .content {
          max-width: 100%;
          margin: 0;
          padding: 0;
        }
        
        /* æ ‡é¢˜æ ·å¼ */
        h1 {
          font-size: 20pt;
          color: #2c3e50;
          border-bottom: 2px solid #3498db;
          padding-bottom: 0.3cm;
          margin-top: 1.5cm;
          margin-bottom: 1cm;
          page-break-after: avoid;
        }
        
        h2 {
          font-size: 16pt;
          color: #34495e;
          border-bottom: 1px solid #bdc3c7;
          padding-bottom: 0.2cm;
          margin-top: 1.2cm;
          margin-bottom: 0.8cm;
          page-break-after: avoid;
        }
        
        h3 {
          font-size: 14pt;
          color: #2c3e50;
          margin-top: 1cm;
          margin-bottom: 0.6cm;
          page-break-after: avoid;
        }
        
        h4, h5, h6 {
          font-size: 12pt;
          color: #34495e;
          margin-top: 0.8cm;
          margin-bottom: 0.4cm;
          page-break-after: avoid;
        }
        
        /* æ®µè½å’Œæ–‡æœ¬æ ·å¼ */
        p {
          margin: 0.6em 0;
          text-align: justify;
          line-height: 1.7;
        }
        
        strong {
          color: #2c3e50;
          font-weight: 600;
        }
        
        em {
          color: #34495e;
          font-style: italic;
        }
        
        /* é“¾æ¥æ ·å¼ */
        a {
          color: #3498db;
          text-decoration: none;
        }
        
        a:hover {
          text-decoration: underline;
        }
        
        /* ä»£ç æ ·å¼ */
        code {
          font-family: "Noto Sans Mono CJK SC", "SF Mono", "Monaco", "Inconsolata", "Fira Mono", "Droid Sans Mono", monospace;
          background-color: #f8f9fa;
          padding: 0.2em 0.4em;
          border-radius: 4px;
          font-size: 10pt;
          color: #e74c3c;
          border: 1px solid #e1e4e8;
        }
        
        pre {
          background-color: #f8f9fa;
          border: 1px solid #e1e4e8;
          border-radius: 8px;
          padding: 1em;
          overflow: auto;
          font-size: 10pt;
          line-height: 1.4;
          page-break-inside: avoid;
          margin: 1em 0;
        }
        
        pre code {
          background: none;
          padding: 0;
          border: none;
          color: #2c3e50;
          font-size: 10pt;
        }
        
        /* å¼•ç”¨å—æ ·å¼ */
        blockquote {
          border-left: 4px solid #3498db;
          margin: 1em 0;
          padding: 0.5em 1em;
          background-color: #ecf0f1;
          color: #2c3e50;
          border-radius: 0 8px 8px 0;
        }
        
        blockquote p {
          margin: 0.5em 0;
        }
        
        /* åˆ—è¡¨æ ·å¼ */
        ul, ol {
          margin: 0.8em 0;
          padding-left: 2em;
        }
        
        li {
          margin: 0.4em 0;
          line-height: 1.6;
        }
        
        /* è¡¨æ ¼æ ·å¼ */
        table {
          border-collapse: collapse;
          width: 100%;
          margin: 1em 0;
          page-break-inside: avoid;
          font-size: 10pt;
        }
        
        th {
          background-color: #34495e;
          color: white;
          font-weight: 600;
          padding: 0.6em;
          text-align: left;
          border: 1px solid #2c3e50;
        }
        
        td {
          padding: 0.6em;
          border: 1px solid #bdc3c7;
          background-color: white;
        }
        
        tr:nth-child(even) td {
          background-color: #f8f9fa;
        }
        
        /* å›¾ç‰‡æ ·å¼ */
        img {
          max-width: 100%;
          height: auto;
          display: block;
          margin: 1em auto;
          page-break-inside: avoid;
          border-radius: 4px;
          box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        
        /* åˆ†é¡µæ§åˆ¶ */
        .newpage {
          page-break-before: always;
        }
        
        /* é¿å…åœ¨æ ‡é¢˜å‰åˆ†é¡µ */
        h1, h2, h3 {
          page-break-after: avoid;
        }
        
        /* ç¡®ä¿ä»£ç å—å’Œè¡¨æ ¼ä¸è¢«åˆ†å‰² */
        pre, table, img {
          page-break-inside: avoid;
        }
        
        /* ç« èŠ‚å¼€å§‹çš„ç©ºç™½æ§åˆ¶ */
        h1:first-child {
          margin-top: 0.5cm;
        }
        
        /* æ‰“å°ä¼˜åŒ– */
        @media print {
          .cover {
            height: 100vh;
          }
          
          pre, code {
            white-space: pre-wrap;
            word-wrap: break-word;
          }
        }
        EOF

    - name: Generate Enhanced PDF
      run: |
        echo "ğŸ¯ ç”Ÿæˆå¢å¼ºæ ·å¼çš„ PDF..."
        
        # ä½¿ç”¨ WeasyPrint ç”Ÿæˆ PDF
        weasyprint _temp/document.html _output/javascript-guide-enhanced.pdf \
          -s _temp/enhanced.css \
          --presentational-hints \
          --optimize-size
        
        echo "âœ… å¢å¼ºæ ·å¼ PDF ç”Ÿæˆå®Œæˆ"
        echo "PDF æ–‡ä»¶ä¿¡æ¯: $(ls -lh _output/javascript-guide-enhanced.pdf)"

    - name: Create Alternative Simple PDF
      run: |
        echo "ğŸ”„ åŒæ—¶ç”Ÿæˆç®€æ´ç‰ˆ PDF..."
        
        # åˆ›å»ºç®€æ´ç‰ˆ CSS
        cat > _temp/simple.css << 'EOF'
        @page {
          size: A4;
          margin: 2cm;
        }
        
        body {
          font-family: "Noto Sans CJK SC", sans-serif;
          font-size: 11pt;
          line-height: 1.6;
          color: #000;
        }
        
        h1, h2, h3 {
          color: #333;
          page-break-after: avoid;
        }
        
        h1 { font-size: 16pt; border-bottom: 1px solid #ccc; }
        h2 { font-size: 14pt; }
        h3 { font-size: 12pt; }
        
        code {
          font-family: "Noto Sans Mono CJK SC", monospace;
          background: #f5f5f5;
          padding: 0.1em 0.3em;
        }
        
        pre {
          background: #f5f5f5;
          padding: 1em;
          border-radius: 4px;
          page-break-inside: avoid;
        }
        EOF
        
        # ç”Ÿæˆç®€æ´ç‰ˆ
        weasyprint _temp/document.html _output/javascript-guide-simple.pdf \
          -s _temp/simple.css
        
        echo "âœ… ç®€æ´ç‰ˆ PDF ç”Ÿæˆå®Œæˆ"

    - name: Verify and Compare Results
      run: |
        echo "ğŸ“Š éªŒè¯ç”Ÿæˆç»“æœ..."
        
        echo "å¢å¼ºç‰ˆ PDF:"
        ls -lh _output/javascript-guide-enhanced.pdf
        echo ""
        echo "ç®€æ´ç‰ˆ PDF:"
        ls -lh _output/javascript-guide-simple.pdf
        
        # æ£€æŸ¥æ–‡ä»¶å¤§å°
        enhanced_size=$(stat -c%s "_output/javascript-guide-enhanced.pdf")
        simple_size=$(stat -c%s "_output/javascript-guide-simple.pdf")
        
        echo ""
        echo "æ–‡ä»¶å¤§å°å¯¹æ¯”:"
        echo "å¢å¼ºç‰ˆ: $((enhanced_size/1024)) KB"
        echo "ç®€æ´ç‰ˆ: $((simple_size/1024)) KB"

    - name: Upload PDF Artifacts
      uses: actions/upload-artifact@v4
      with:
        name: JavaScript-Guide-PDFs
        path: |
          _output/javascript-guide-enhanced.pdf
          _output/javascript-guide-simple.pdf
        retention-days: 30
