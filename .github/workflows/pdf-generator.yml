name: Generate PDF from Markdown

on:
  push:
    branches: [main, master]
  workflow_dispatch:

jobs:
  generate-pdf:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout Code
      uses: actions/checkout@v4
      with:
        submodules: recursive
        fetch-depth: 0

    - name: Setup Environment
      run: |
        mkdir -p _output _temp
        echo "å·¥ä½œç›®å½•ç»“æ„:"
        find . -type f -name "*.md" | head -20

    - name: Install Dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          pandoc \
          texlive-xetex \
          texlive-latex-recommended \
          texlive-latex-extra \
          texlive-fonts-recommended \
          texlive-fonts-extra \
          texlive-science \
          texlive-pictures \
          texlive-luatex \
          lmodern \
          fonts-noto-cjk \
          fonts-noto-color-emoji \
          poppler-utils \
          python3-pygments  # minted éœ€è¦ Pygments

    - name: Find and Combine All Markdown Files
      id: combine_files
      run: |
        echo "ğŸ” æŸ¥æ‰¾æ‰€æœ‰ Markdown æ–‡ä»¶..."
        
        # æŸ¥æ‰¾æ‰€æœ‰ markdown æ–‡ä»¶ï¼Œæ’é™¤æ— å…³ç›®å½•
        find . -name "*.md" -type f \
          ! -path "./.git/*" \
          ! -path "./node_modules/*" \
          ! -path "./_output/*" \
          ! -path "./_temp/*" \
          ! -name "README.md" \
          ! -name "CONTRIBUTING.md" \
          ! -name "CHANGELOG.md" > _temp/md_files.txt
        
        # åˆ›å»ºåˆå¹¶æ–‡ä»¶
        if [ -f "README.md" ]; then
          echo "ä½¿ç”¨ README.md ä½œä¸ºå¼€å¤´"
          cp README.md _temp/combined.md
          echo "" >> _temp/combined.md
          echo "\\newpage" >> _temp/combined.md
          echo "" >> _temp/combined.md
        else
          touch _temp/combined.md
        fi
        
        # æŒ‰æ•°å­—é¡ºåºæ’åºæ–‡ä»¶
        if [ -s "_temp/md_files.txt" ]; then
          echo "ğŸ“š æ‰¾åˆ°ä»¥ä¸‹ Markdown æ–‡ä»¶:"
          cat _temp/md_files.txt
          
          # æŒ‰æ•°å­—æ’åº
          sort -V _temp/md_files.txt > _temp/sorted_files.txt
          
          # åˆå¹¶æ‰€æœ‰æ–‡ä»¶
          while IFS= read -r file; do
            if [ -f "$file" ]; then
              echo "æ·»åŠ æ–‡ä»¶: $file"
              echo "# $(basename "$file" .md)" >> _temp/combined.md
              echo "" >> _temp/combined.md
              cat "$file" >> _temp/combined.md
              echo "" >> _temp/combined.md
              echo "\\newpage" >> _temp/combined.md
              echo "" >> _temp/combined.md
            fi
          done < _temp/sorted_files.txt
        else
          echo "âš ï¸ æ²¡æœ‰æ‰¾åˆ°å…¶ä»– Markdown æ–‡ä»¶"
        fi
        
        echo "âœ… åˆå¹¶å®Œæˆï¼Œæ€»å¤§å°:"
        ls -lh _temp/combined.md
        echo "è¡Œæ•°ç»Ÿè®¡:"
        wc -l _temp/combined.md

    - name: Advanced Preprocessing for LaTeX
      run: |
        echo "ğŸ”§ é«˜çº§é¢„å¤„ç† Markdown æ–‡ä»¶..."
        
        # å¤‡ä»½åŸå§‹æ–‡ä»¶
        cp _temp/combined.md _temp/combined_backup.md
        
        # æ–¹æ³•1: ä½¿ç”¨æ›´ç²¾ç¡®çš„è½¬ä¹‰å¤„ç†
        python3 << 'EOF'
        import re
        
        with open('_temp/combined.md', 'r', encoding='utf-8') as f:
            content = f.read()
        
        # è½¬ä¹‰ LaTeX ç‰¹æ®Šå­—ç¬¦ï¼Œä½†åœ¨ä»£ç å—ä¸­ä¿æŒåŸæ ·
        lines = content.split('\n')
        in_code_block = False
        processed_lines = []
        
        for line in lines:
            # æ£€æµ‹ä»£ç å—å¼€å§‹/ç»“æŸ
            if line.strip().startswith('```'):
                in_code_block = not in_code_block
                processed_lines.append(line)
                continue
            
            if in_code_block:
                # åœ¨ä»£ç å—ä¸­ï¼Œæˆ‘ä»¬ä¿æŒå†…å®¹ä¸å˜
                processed_lines.append(line)
            else:
                # åœ¨æ™®é€šæ–‡æœ¬ä¸­ï¼Œè½¬ä¹‰ç‰¹æ®Šå­—ç¬¦
                # å…ˆè½¬ä¹‰åæ–œæ 
                line = line.replace('\\', '\\\\textbackslash{}')
                # è½¬ä¹‰å…¶ä»–ç‰¹æ®Šå­—ç¬¦
                line = line.replace('#', '\\#')
                line = line.replace('$', '\\$')
                line = line.replace('%', '\\%')
                line = line.replace('&', '\\&')
                line = line.replace('_', '\\_')
                line = line.replace('{', '\\{')
                line = line.replace('}', '\\}')
                line = line.replace('~', '\\textasciitilde{}')
                line = line.replace('^', '\\textasciicircum{}')
                processed_lines.append(line)
        
        processed_content = '\n'.join(processed_lines)
        
        with open('_temp/combined_processed.md', 'w', encoding='utf-8') as f:
            f.write(processed_content)
        
        print("âœ… Python é¢„å¤„ç†å®Œæˆ")
        EOF
        
        # å¦‚æœ Python ä¸å¯ç”¨ï¼Œä½¿ç”¨ sed ä½œä¸ºå¤‡ç”¨
        if [ ! -f "_temp/combined_processed.md" ]; then
          echo "ä½¿ç”¨ sed å¤‡ç”¨é¢„å¤„ç†..."
          cp _temp/combined_backup.md _temp/combined_processed.md
          # åŸºæœ¬çš„è½¬ä¹‰å¤„ç†
          sed -i 's/\\/\\\\textbackslash{}/g' _temp/combined_processed.md
          sed -i 's/#/\\#/g' _temp/combined_processed.md
          sed -i 's/\$/\\$/g' _temp/combined_processed.md
          sed -i 's/%/\\%/g' _temp/combined_processed.md
          sed -i 's/&/\\&/g' _temp/combined_processed.md
          sed -i 's/_/\\_/g' _temp/combined_processed.md
          sed -i 's/{/\\{/g' _temp/combined_processed.md
          sed -i 's/}/\\}/g' _temp/combined_processed.md
        fi

    - name: Create Problem Debug Info
      run: |
        echo "ğŸ› è°ƒè¯•é—®é¢˜åŒºåŸŸ (ç¬¬2100-2120è¡Œ):"
        if [ -f "_temp/combined_processed.md" ]; then
          echo "å¤„ç†åçš„æ–‡ä»¶:"
          sed -n '2100,2120p' _temp/combined_processed.md
        fi
        if [ -f "_temp/combined_backup.md" ]; then
          echo "åŸå§‹æ–‡ä»¶:"
          sed -n '2100,2120p' _temp/combined_backup.md
        fi

    - name: Create Robust LaTeX Header (No Minted)
      run: |
        mkdir -p _temp
        cat > _temp/header.tex << 'EOFEND'
        \usepackage{titlesec}
        \usepackage{fancyhdr}
        \usepackage{xcolor}
        \usepackage{hyperref}
        \usepackage{bookmark}
        \usepackage{listings}
        \usepackage{fontspec}
        
        % é˜²æ­¢ä»£ç å—ä¸­çš„ç‰¹æ®Šå­—ç¬¦å‡ºé”™
        \usepackage[utf8]{inputenc}
        \usepackage{upquote} % ç¡®ä¿å¼•å·æ­£ç¡®å¤„ç†
        
        % ç« èŠ‚æ ‡é¢˜æ ·å¼
        \titleformat{\chapter}[display]
          {\normalfont\huge\bfseries\color{blue!70!black}}
          {\chaptertitlename\ \thechapter}{20pt}{\Huge}
        
        \titleformat{\section}
          {\normalfont\Large\bfseries\color{blue!60!black}}
          {\thesection}{1em}{}
        
        \titleformat{\subsection}
          {\normalfont\large\bfseries\color{blue!50!black}}
          {\thesubsection}{1em}{}
        
        % é¡µçœ‰é¡µè„šè®¾ç½®
        \pagestyle{fancy}
        \fancyhf{}
        \fancyhead[L]{\leftmark}
        \fancyhead[R]{\thepage}
        \renewcommand{\headrulewidth}{0.5pt}
        
        % è¶…é“¾æ¥è®¾ç½®
        \hypersetup{
          pdfauthor={Richard-Billyham},
          pdftitle={JavaScriptæƒå¨æŒ‡å—ç¬¬ä¸ƒç‰ˆ},
          pdfsubject={JavaScriptç¼–ç¨‹æŒ‡å—},
          pdfkeywords={JavaScript,ç¼–ç¨‹,æŒ‡å—},
          bookmarksnumbered=true,
          bookmarksopen=true,
          pdfstartview=FitH,
          linkcolor=blue,
          urlcolor=cyan,
          citecolor=green
        }
        
        % ä»£ç åˆ—è¡¨è®¾ç½® - é¿å…ä½¿ç”¨ minted
        \lstset{
          basicstyle=\ttfamily\footnotesize,
          breaklines=true,
          frame=single,
          backgroundcolor=\color{gray!5},
          captionpos=b,
          abovecaptionskip=10pt,
          belowcaptionskip=10pt,
          xleftmargin=10pt,
          xrightmargin=10pt,
          upquote=true,
          showstringspaces=false,
          literate={\\\}{{\textbackslash}}1 % æ­£ç¡®å¤„ç†åæ–œæ 
        }
        
        % å®šä¹‰ JavaScript è¯­æ³•é«˜äº®
        \lstdefinelanguage{JavaScript}{
          keywords={typeof, new, true, false, catch, function, return, null, catch, switch, var, if, in, while, do, else, case, break},
          keywordstyle=\color{blue}\bfseries,
          ndkeywords={class, export, boolean, throw, implements, import, this},
          ndkeywordstyle=\color{darkgray}\bfseries,
          identifierstyle=\color{black},
          sensitive=false,
          comment=[l]{//},
          morecomment=[s]{/*}{*/},
          commentstyle=\color{purple}\ttfamily,
          stringstyle=\color{red}\ttfamily,
          morestring=[b]',
          morestring=[b]"
        }
        
        \lstset{
          language=JavaScript,
          extendedchars=true,
          basicstyle=\footnotesize\ttfamily,
          showstringspaces=false,
          showspaces=false,
          numbers=left,
          numberstyle=\footnotesize,
          numbersep=9pt,
          tabsize=2,
          breaklines=true,
          showtabs=false,
          captionpos=b
        }
        EOFEND

    - name: Generate PDF with Safe Settings
      run: |
        WORKSPACE_PATH="${{ github.workspace }}"
        
        echo "ğŸ¯ å¼€å§‹ç”ŸæˆPDF (å®‰å…¨è®¾ç½®)..."
        echo "è¾“å…¥æ–‡ä»¶å¤§å°: $(ls -lh _temp/combined_processed.md)"
        
        # ä½¿ç”¨å®‰å…¨çš„pandocè®¾ç½®ï¼Œé¿å…minted
        pandoc "_temp/combined_processed.md" -o "_output/javascript-guide.pdf" \
          --metadata title="JavaScriptæƒå¨æŒ‡å—ç¬¬ä¸ƒç‰ˆ" \
          --metadata author="Richard-Billyham" \
          --table-of-contents \
          --toc-depth=3 \
          --number-sections \
          --pdf-engine=xelatex \
          -V mainfont="Noto Sans CJK SC" \
          -V sansfont="Noto Sans CJK SC" \
          -V monofont="Noto Sans Mono CJK SC" \
          -V geometry:margin=2.5cm \
          -V geometry:a4paper \
          -V colorlinks=true \
          -V linkcolor=blue \
          -V urlcolor=cyan \
          -V toccolor=blue \
          -V papersize=a4 \
          -V fontsize=11pt \
          -V linestretch=1.2 \
          -V secnumdepth=3 \
          --include-in-header="$WORKSPACE_PATH/_temp/header.tex" \
          --highlight-style=pygments \
          --listings \
          -f markdown+smart \
          --wrap=auto
        
        echo "âœ… PDFç”Ÿæˆå‘½ä»¤æ‰§è¡Œå®Œæˆ"

    - name: Alternative PDF Generation Method
      if: failure()
      run: |
        echo "ğŸ”„ å°è¯•æ›¿ä»£PDFç”Ÿæˆæ–¹æ³•..."
        WORKSPACE_PATH="${{ github.workspace }}"
        
        # åˆ›å»ºæç®€header
        cat > _temp/minimal_header.tex << 'EOF'
        \usepackage{fontspec}
        \usepackage{hyperref}
        \hypersetup{
          pdfauthor={Richard-Billyham},
          pdftitle={JavaScriptæƒå¨æŒ‡å—ç¬¬ä¸ƒç‰ˆ},
          colorlinks=true,
          linkcolor=blue,
          urlcolor=cyan
        }
        \usepackage{geometry}
        \geometry{a4paper, margin=2.5cm}
        EOF
        
        # ä½¿ç”¨æç®€è®¾ç½®ç”ŸæˆPDF
        pandoc "_temp/combined_backup.md" -o "_output/javascript-guide-simple.pdf" \
          --metadata title="JavaScriptæƒå¨æŒ‡å—ç¬¬ä¸ƒç‰ˆ" \
          --metadata author="Richard-Billyham" \
          --table-of-contents \
          --toc-depth=2 \
          --pdf-engine=xelatex \
          -V mainfont="Noto Sans CJK SC" \
          -V geometry:margin=2.5cm \
          -V geometry:a4paper \
          -V papersize=a4 \
          -V fontsize=11pt \
          --include-in-header="$WORKSPACE_PATH/_temp/minimal_header.tex" \
          --highlight-style=haddock
        
        echo "âœ… æ›¿ä»£PDFç”Ÿæˆå®Œæˆ"

    - name: Final PDF Generation Attempt
      if: failure()
      run: |
        echo "ğŸ”„ æœ€ç»ˆå°è¯•ï¼šåŸºæœ¬PDFç”Ÿæˆ..."
        
        # æœ€åŸºæœ¬çš„PDFç”Ÿæˆï¼Œä¸ä½¿ç”¨ä»»ä½•é«˜çº§ç‰¹æ€§
        pandoc "_temp/combined_backup.md" -o "_output/javascript-guide-basic.pdf" \
          --metadata title="JavaScriptæƒå¨æŒ‡å—ç¬¬ä¸ƒç‰ˆ" \
          --pdf-engine=xelatex \
          -V mainfont="Noto Sans CJK SC" \
          -V geometry:margin=2.5cm \
          -V papersize=a4
        
        echo "âœ… åŸºæœ¬PDFç”Ÿæˆå®Œæˆ"

    - name: Verify PDF Generation
      run: |
        echo "ğŸ“Š éªŒè¯PDFæ–‡ä»¶..."
        # æ£€æŸ¥ä»»ä½•ç”Ÿæˆçš„PDF
        for pdf in "_output/javascript-guide.pdf" "_output/javascript-guide-simple.pdf" "_output/javascript-guide-basic.pdf"; do
          if [ -f "$pdf" ]; then
            echo "æ‰¾åˆ°PDF: $pdf"
            PDF_SIZE=$(stat -c%s "$pdf")
            echo "æ–‡ä»¶å¤§å°: $PDF_SIZE å­—èŠ‚ ($(echo "scale=2; $PDF_SIZE/1024/1024" | bc) MB)"
            
            if command -v pdfinfo >/dev/null 2>&1; then
              echo "PDF ä¿¡æ¯:"
              pdfinfo "$pdf" | head -10 || echo "æ— æ³•è¯»å–PDFè¯¦ç»†ä¿¡æ¯"
            fi
            
            if [ "$PDF_SIZE" -lt 102400 ]; then
              echo "âš ï¸  è­¦å‘Š: $pdf æ–‡ä»¶å¯èƒ½å¤ªå°"
            else
              echo "âœ… $pdf æ–‡ä»¶å¤§å°æ­£å¸¸"
              MAIN_PDF="$pdf"
            fi
            echo "---"
          fi
        done
        
        if [ -z "$MAIN_PDF" ]; then
          echo "âŒ æ²¡æœ‰æ‰¾åˆ°æœ‰æ•ˆçš„PDFæ–‡ä»¶"
          exit 1
        fi

    - name: Upload PDF Artifact
      uses: actions/upload-artifact@v4
      with:
        name: JavaScript-Guide-PDF
        path: |
          _output/javascript-guide.pdf
          _output/javascript-guide-simple.pdf
          _output/javascript-guide-basic.pdf
        retention-days: 30
