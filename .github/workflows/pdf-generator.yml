name: Generate PDF from JavaScript Guide

on:
  push:
    branches: [main, master]
  workflow_dispatch:

jobs:
  generate-pdf:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout Code
      uses: actions/checkout@v4
      with:
        submodules: recursive
        fetch-depth: 0

    - name: Setup Environment
      run: |
        echo "ğŸ“ è®¾ç½®å·¥ä½œç¯å¢ƒ..."
        mkdir -p _output _temp
        echo "å½“å‰ç›®å½•: $(pwd)"
        echo "é¡¹ç›®ç»“æ„:"
        find . -name "*.md" -type f | sort

    - name: Install Dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          pandoc \
          texlive-xetex \
          texlive-latex-recommended \
          texlive-fonts-recommended \
          fonts-noto-cjk \
          fonts-noto-color-emoji \
          poppler-utils

    - name: Create Structured Markdown File
      run: |
        echo "ğŸ“ åˆ›å»ºç»“æ„åŒ–Markdownæ–‡ä»¶..."
        
        # åˆ›å»ºå°é¢å’Œç›®å½•
        cat > _temp/complete.md << 'EOF'
        # JavaScriptæƒå¨æŒ‡å—ç¬¬ä¸ƒç‰ˆ
        
        **ä½œè€…: Richard-Billyham**
        
        **ç”Ÿæˆæ—¶é—´: $(date)**
        
        ***
        
        ## ç›®å½•
        
        EOF
        
        # æ·»åŠ README.mdå†…å®¹
        if [ -f "README.md" ]; then
          echo "æ·»åŠ ç®€ä»‹..."
          echo "# ç®€ä»‹" >> _temp/complete.md
          echo "" >> _temp/complete.md
          cat "README.md" >> _temp/complete.md
          echo "" >> _temp/complete.md
          echo "\\newpage" >> _temp/complete.md
          echo "" >> _temp/complete.md
        fi
        
        # æŒ‰æ­£ç¡®é¡ºåºæ·»åŠ ç« èŠ‚
        chapters=(
          "./docs/ch1.md"
          "./docs/ch2.md" 
          "./docs/ch3.md"
          "./docs/ch4.md"
          "./docs/ch5.md"
          "./docs/ch6.md"
          "./docs/ch7.md"
          "./docs/ch8.md"
          "./docs/ch9.md"
          "./docs/ch10.md"
          "./docs/ch11.md"
          "./docs/ch12.md"
          "./docs/ch13.md"
          "./docs/ch14.md"
          "./docs/ch15.md"
          "./docs/ch16.md"
          "./docs/ch17.md"
        )
        
        for chapter in "${chapters[@]}"; do
          if [ -f "$chapter" ]; then
            echo "æ·»åŠ ç« èŠ‚: $chapter"
            # æå–ç« èŠ‚æ ‡é¢˜
            title=$(basename "$chapter" .md | sed 's/ch/ç¬¬/' | sed 's/$/ç« /')
            echo "# $title" >> _temp/complete.md
            echo "" >> _temp/complete.md
            cat "$chapter" >> _temp/complete.md
            echo "" >> _temp/complete.md
            echo "\\newpage" >> _temp/complete.md
            echo "" >> _temp/complete.md
          else
            echo "âš ï¸  ç« èŠ‚ä¸å­˜åœ¨: $chapter"
          fi
        done
        
        echo "âœ… æ–‡ä»¶åˆ›å»ºå®Œæˆ"
        echo "æ–‡ä»¶å¤§å°: $(ls -lh _temp/complete.md)"

    - name: Create Safe LaTeX Header
      run: |
        echo "ğŸ“„ åˆ›å»ºå®‰å…¨çš„LaTeXå¤´æ–‡ä»¶..."
        mkdir -p _temp
        
        cat > _temp/header.tex << 'EOF'
        \usepackage{fontspec}
        \setmainfont{Noto Sans CJK SC}
        \usepackage{geometry}
        \geometry{a4paper, margin=2.5cm}
        \usepackage{titlesec}
        \usepackage{fancyhdr}
        \usepackage{xcolor}
        \usepackage{hyperref}
        
        % ç« èŠ‚æ ·å¼
        \titleformat{\chapter}
          {\normalfont\Huge\bfseries}{\thechapter}{1em}{}
        \titleformat{\section}
          {\normalfont\Large\bfseries}{\thesection}{1em}{}
          
        % é¡µçœ‰é¡µè„š
        \pagestyle{fancy}
        \fancyhf{}
        \fancyhead[L]{\leftmark}
        \fancyhead[R]{\thepage}
        
        % è¶…é“¾æ¥è®¾ç½®
        \hypersetup{
          colorlinks=true,
          linkcolor=blue,
          urlcolor=cyan,
          pdftitle={JavaScriptæƒå¨æŒ‡å—ç¬¬ä¸ƒç‰ˆ},
          pdfauthor={Richard-Billyham}
        }
        
        % å¤„ç†ä»£ç å—ä¸­çš„ç‰¹æ®Šå­—ç¬¦
        \usepackage{listings}
        \lstset{
          basicstyle=\ttfamily\small,
          breaklines=true,
          frame=single,
          backgroundcolor=\color{gray!5},
          escapeinside={\%*}{*)},  % å…è®¸åœ¨ä»£ç ä¸­æ’å…¥LaTeX
          upquote=true  % æ­£ç¡®å¤„ç†å¼•å·
        }
        EOF

    - name: Generate PDF - Method 1 (Direct)
      run: |
        echo "ğŸ¯ æ–¹æ³•1: ç›´æ¥ç”ŸæˆPDF..."
        
        pandoc "_temp/complete.md" -o "_output/javascript-guide.pdf" \
          --pdf-engine=xelatex \
          -V mainfont="Noto Sans CJK SC" \
          -V geometry:margin=2.5cm \
          -V papersize=a4 \
          --table-of-contents \
          --toc-depth=3 \
          -M title="JavaScriptæƒå¨æŒ‡å—ç¬¬ä¸ƒç‰ˆ" \
          -M author="Richard-Billyham"
        
        echo "âœ… æ–¹æ³•1å®Œæˆ"

    - name: Generate PDF - Method 2 (With Header)
      if: failure()
      run: |
        echo "ğŸ¯ æ–¹æ³•2: ä½¿ç”¨å¤´æ–‡ä»¶ç”ŸæˆPDF..."
        
        pandoc "_temp/complete.md" -o "_output/javascript-guide-with-header.pdf" \
          --pdf-engine=xelatex \
          --include-in-header="${{ github.workspace }}/_temp/header.tex" \
          --table-of-contents \
          --toc-depth=3 \
          -M title="JavaScriptæƒå¨æŒ‡å—ç¬¬ä¸ƒç‰ˆ" \
          -M author="Richard-Billyham"
        
        echo "âœ… æ–¹æ³•2å®Œæˆ"

    - name: Generate PDF - Method 3 (Minimal)
      if: failure()
      run: |
        echo "ğŸ¯ æ–¹æ³•3: æœ€å°åŒ–è®¾ç½®..."
        
        # åªå¤„ç†å‰å‡ ç« æ¥æµ‹è¯•
        head -n 1000 "_temp/complete.md" > "_temp/test.md"
        
        pandoc "_temp/test.md" -o "_output/javascript-guide-test.pdf" \
          --pdf-engine=xelatex \
          -V mainfont="Noto Sans CJK SC" \
          -V geometry:margin=2.5cm
        
        echo "âœ… æ–¹æ³•3å®Œæˆ"

    - name: Check and Upload Results
      run: |
        echo "ğŸ“Š æ£€æŸ¥ç”Ÿæˆç»“æœ..."
        
        # æ£€æŸ¥æ‰€æœ‰PDFæ–‡ä»¶
        success=false
        for pdf in _output/*.pdf; do
          if [ -f "$pdf" ]; then
            size=$(stat -c%s "$pdf")
            echo "âœ… æ‰¾åˆ°: $pdf ($((size/1024)) KB)"
            if [ $size -gt 102400 ]; then  # å¤§äº100KB
              success=true
              echo "ğŸ‰ æ‰¾åˆ°æœ‰æ•ˆçš„PDFæ–‡ä»¶: $pdf"
            fi
          fi
        done
        
        if [ "$success" = false ]; then
          echo "âŒ æ²¡æœ‰ç”Ÿæˆæœ‰æ•ˆçš„PDFæ–‡ä»¶"
          echo "è°ƒè¯•ä¿¡æ¯:"
          echo "complete.md å‰20è¡Œ:"
          head -20 "_temp/complete.md"
          echo ""
          echo "complete.md æœ€å10è¡Œ:"
          tail -10 "_temp/complete.md"
          exit 1
        fi

    - name: Upload PDF Artifacts
      uses: actions/upload-artifact@v4
      with:
        name: JavaScript-Guide-PDF
        path: _output/*.pdf
        retention-days: 30
