name: Generate PDF from JavaScript Guide

on:
  push:
    branches: [main, master]
  workflow_dispatch:

jobs:
  generate-pdf:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout Code
      uses: actions/checkout@v4
      with:
        submodules: recursive
        fetch-depth: 0

    - name: Setup Environment
      run: |
        echo "ğŸ“ è®¾ç½®å·¥ä½œç¯å¢ƒ..."
        mkdir -p _output _temp
        echo "å½“å‰ç›®å½•: $(pwd)"

    - name: Install Dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          pandoc \
          texlive-xetex \
          texlive-latex-recommended \
          texlive-fonts-recommended \
          texlive-latex-extra \
          fonts-noto-cjk \
          fonts-noto-color-emoji \
          poppler-utils \
          python3

    - name: Create Simple Combined File
      run: |
        echo "ğŸ“ åˆ›å»ºç®€å•åˆå¹¶æ–‡ä»¶..."
        
        # åˆ›å»ºç®€å•çš„åˆå¹¶æ–‡ä»¶ï¼Œä¸æ·»åŠ é¢å¤–æ ¼å¼
        touch _temp/simple_combined.md
        
        # æ·»åŠ README
        if [ -f "README.md" ]; then
          cat "README.md" >> _temp/simple_combined.md
          echo "" >> _temp/simple_combined.md
          echo "---" >> _temp/simple_combined.md
          echo "" >> _temp/simple_combined.md
        fi
        
        # æŒ‰é¡ºåºæ·»åŠ ç« èŠ‚
        for i in {1..17}; do
          chapter_file="./docs/ch${i}.md"
          if [ -f "$chapter_file" ]; then
            echo "æ·»åŠ : $chapter_file"
            echo "# ç¬¬${i}ç« " >> _temp/simple_combined.md
            echo "" >> _temp/simple_combined.md
            cat "$chapter_file" >> _temp/simple_combined.md
            echo "" >> _temp/simple_combined.md
            echo "---" >> _temp/simple_combined.md
            echo "" >> _temp/simple_combined.md
          fi
        done
        
        echo "âœ… ç®€å•åˆå¹¶å®Œæˆ"
        echo "æ–‡ä»¶å¤§å°: $(ls -lh _temp/simple_combined.md)"

    - name: Create Robust LaTeX Header
      run: |
        echo "ğŸ“„ åˆ›å»ºå¥å£®çš„LaTeXå¤´æ–‡ä»¶..."
        
        cat > _temp/header.tex << 'EOF'
        \usepackage{fontspec}
        \setmainfont{Noto Sans CJK SC}
        \usepackage{geometry}
        \geometry{a4paper, margin=2.5cm}
        \usepackage{hyperref}
        
        % è¶…é“¾æ¥è®¾ç½®
        \hypersetup{
          colorlinks=true,
          linkcolor=blue,
          urlcolor=cyan,
          pdftitle={JavaScriptæƒå¨æŒ‡å—ç¬¬ä¸ƒç‰ˆ},
          pdfauthor={Richard-Billyham}
        }
        
        % å¤„ç†Unicodeå­—ç¬¦
        \usepackage{newunicodechar}
        \newunicodechar{^^^^ffff}{\ensuremath{\infty}}
        
        % ç¦ç”¨å¤æ‚åŒ…ï¼Œé¿å…é”™è¯¯
        \usepackage{listings}
        \lstset{
          basicstyle=\ttfamily\small,
          breaklines=true,
          frame=none,
          upquote=true
        }
        EOF

    - name: Method 1 - Direct Simple Conversion
      run: |
        echo "ğŸ¯ æ–¹æ³•1: ç›´æ¥ç®€å•è½¬æ¢..."
        
        # æœ€ç®€å•çš„è½¬æ¢ï¼Œä¸ä½¿ç”¨ä»»ä½•å¤æ‚è®¾ç½®
        pandoc "_temp/simple_combined.md" -o "_output/simple.pdf" \
          --pdf-engine=xelatex \
          -V mainfont="Noto Sans CJK SC" \
          -V geometry:margin=2.5cm
        
        echo "âœ… æ–¹æ³•1å®Œæˆ"

    - name: Method 2 - With TOC and Metadata
      if: failure()
      run: |
        echo "ğŸ¯ æ–¹æ³•2: å¸¦ç›®å½•å’Œå…ƒæ•°æ®..."
        
        pandoc "_temp/simple_combined.md" -o "_output/with-toc.pdf" \
          --pdf-engine=xelatex \
          -V mainfont="Noto Sans CJK SC" \
          -V geometry:margin=2.5cm \
          --table-of-contents \
          -M title="JavaScriptæƒå¨æŒ‡å—ç¬¬ä¸ƒç‰ˆ" \
          -M author="Richard-Billyham"
        
        echo "âœ… æ–¹æ³•2å®Œæˆ"

    - name: Method 3 - Remove Problematic Content
      if: failure()
      run: |
        echo "ğŸ¯ æ–¹æ³•3: ç§»é™¤é—®é¢˜å†…å®¹..."
        
        # åˆ›å»ºPythonè„šæœ¬æ¥æ¸…ç†é—®é¢˜å†…å®¹
        cat > _temp/clean_content.py << 'EOF'
        import re
        import sys
        
        def clean_content(text):
            # ç§»é™¤æˆ–æ›¿æ¢å¯èƒ½å¯¼è‡´é—®é¢˜çš„Unicodeåºåˆ—
            text = re.sub(r'\\u[0-9a-fA-F]{4}', '?', text)  # æ›¿æ¢ \uXXXX
            text = re.sub(r'\\U[0-9a-fA-F]{8}', '?', text)  # æ›¿æ¢ \UXXXXXXXX
            text = re.sub(r'Codepoints above \\uffff', 'Codepoints above U+FFFF', text)
            
            # è½¬ä¹‰LaTeXç‰¹æ®Šå­—ç¬¦ï¼Œä½†åªåœ¨éä»£ç å—ä¸­
            lines = text.split('\n')
            in_code_block = False
            result_lines = []
            
            for line in lines:
                if line.strip().startswith('```'):
                    in_code_block = not in_code_block
                    result_lines.append(line)
                    continue
                    
                if not in_code_block:
                    # åªåœ¨éä»£ç å—ä¸­è½¬ä¹‰ç‰¹æ®Šå­—ç¬¦
                    line = line.replace('\\', '\\\\')
                    line = line.replace('#', '\\#')
                    line = line.replace('$', '\\$')
                    line = line.replace('%', '\\%')
                    line = line.replace('&', '\\&')
                    line = line.replace('_', '\\_')
                    line = line.replace('{', '\\{')
                    line = line.replace('}', '\\}')
                
                result_lines.append(line)
            
            return '\n'.join(result_lines)
        
        with open('_temp/simple_combined.md', 'r', encoding='utf-8') as f:
            content = f.read()
        
        cleaned_content = clean_content(content)
        
        with open('_temp/cleaned.md', 'w', encoding='utf-8') as f:
            f.write(cleaned_content)
        
        print("âœ… å†…å®¹æ¸…ç†å®Œæˆ")
        EOF
        
        python3 _temp/clean_content.py
        
        pandoc "_temp/cleaned.md" -o "_output/cleaned.pdf" \
          --pdf-engine=xelatex \
          -V mainfont="Noto Sans CJK SC" \
          -V geometry:margin=2.5cm
        
        echo "âœ… æ–¹æ³•3å®Œæˆ"

    - name: Method 4 - Convert to HTML First
      if: failure()
      run: |
        echo "ğŸ¯ æ–¹æ³•4: å…ˆè½¬æ¢ä¸ºHTML..."
        
        # å…ˆè½¬æ¢ä¸ºHTML
        pandoc "_temp/simple_combined.md" -o "_temp/document.html" \
          --toc \
          --self-contained \
          -M title="JavaScriptæƒå¨æŒ‡å—ç¬¬ä¸ƒç‰ˆ" \
          -M author="Richard-Billyham"
        
        echo "âœ… HTMLè½¬æ¢å®Œæˆ"
        
        # å°è¯•ä½¿ç”¨weasyprintå°†HTMLè½¬ä¸ºPDF
        if ! command -v weasyprint &> /dev/null; then
          echo "å®‰è£…weasyprint..."
          pip3 install weasyprint
        fi
        
        weasyprint "_temp/document.html" "_output/html-converted.pdf"
        
        echo "âœ… æ–¹æ³•4å®Œæˆ"

    - name: Method 5 - Use Docker with Full LaTeX
      if: failure()
      run: |
        echo "ğŸ¯ æ–¹æ³•5: ä½¿ç”¨å®Œæ•´LaTeXç¯å¢ƒçš„Docker..."
        
        # ä½¿ç”¨å®Œæ•´çš„LaTeX Dockeré•œåƒ
        docker run --rm -v $(pwd):/data pandoc/latex:latest \
          "_temp/simple_combined.md" -o "_output/docker-generated.pdf" \
          --pdf-engine=xelatex \
          -V mainfont="DejaVu Sans" \
          --table-of-contents
        
        echo "âœ… æ–¹æ³•5å®Œæˆ"

    - name: Method 6 - Generate by Individual Chapters
      if: failure()
      run: |
        echo "ğŸ¯ æ–¹æ³•6: å•ç‹¬ç”Ÿæˆæ¯ä¸ªç« èŠ‚..."
        
        # ä¸ºæ¯ä¸ªç« èŠ‚å•ç‹¬ç”ŸæˆPDF
        success_count=0
        
        for i in {1..17}; do
          chapter_file="./docs/ch${i}.md"
          if [ -f "$chapter_file" ]; then
            echo "å¤„ç†: ch${i}.md"
            
            # ç›´æ¥è½¬æ¢ï¼Œä¸åšå¤æ‚å¤„ç†
            if pandoc "$chapter_file" -o "_output/ch${i}.pdf" \
              --pdf-engine=xelatex \
              -V mainfont="Noto Sans CJK SC" \
              -V geometry:margin=2.5cm 2>/dev/null; then
              echo "âœ… ch${i} ç”ŸæˆæˆåŠŸ"
              success_count=$((success_count+1))
            else
              echo "âŒ ch${i} ç”Ÿæˆå¤±è´¥"
            fi
          fi
        done
        
        echo "ç« èŠ‚ç”Ÿæˆå®Œæˆ: $success_count/17 æˆåŠŸ"

    - name: Method 7 - Last Resort Minimal PDF
      if: failure()
      run: |
        echo "ğŸ¯ æ–¹æ³•7: æœ€åæ‰‹æ®µ - æœ€å°PDF..."
        
        # åªç”ŸæˆREADMEå’Œç¬¬ä¸€ç« 
        if [ -f "README.md" ] && [ -f "./docs/ch1.md" ]; then
          {
            cat "README.md"
            echo ""
            echo "---"
            echo ""
            cat "./docs/ch1.md"
          } > _temp/minimal.md
          
          pandoc "_temp/minimal.md" -o "_output/minimal.pdf" \
            --pdf-engine=xelatex \
            -V mainfont="Noto Sans CJK SC"
        fi
        
        echo "âœ… æ–¹æ³•7å®Œæˆ"

    - name: Check Results and Create Final PDF
      run: |
        echo "ğŸ“Š æ£€æŸ¥ç»“æœå¹¶åˆ›å»ºæœ€ç»ˆPDF..."
        
        # æŸ¥æ‰¾ä»»ä½•æˆåŠŸçš„PDF
        found_pdf=""
        for pdf in _output/*.pdf; do
          if [ -f "$pdf" ]; then
            size=$(stat -c%s "$pdf")
            if [ $size -gt 10240 ]; then  # å¤§äº10KB
              echo "âœ… æ‰¾åˆ°æœ‰æ•ˆPDF: $pdf ($((size/1024)) KB)"
              found_pdf="$pdf"
              break
            fi
          fi
        done
        
        if [ -n "$found_pdf" ]; then
          # å¤åˆ¶ç¬¬ä¸€ä¸ªæ‰¾åˆ°çš„æœ‰æ•ˆPDFä½œä¸ºæœ€ç»ˆç»“æœ
          cp "$found_pdf" "_output/JavaScriptæƒå¨æŒ‡å—.pdf"
          echo "ğŸ‰ æœ€ç»ˆPDFåˆ›å»ºæˆåŠŸ: _output/JavaScriptæƒå¨æŒ‡å—.pdf"
        else
          echo "âŒ æ²¡æœ‰æ‰¾åˆ°æœ‰æ•ˆçš„PDFæ–‡ä»¶"
          echo "è°ƒè¯•ä¿¡æ¯:"
          echo "è¾“å‡ºç›®å½•å†…å®¹:"
          ls -la _output/ || echo "è¾“å‡ºç›®å½•ä¸ºç©º"
          echo "ä¸´æ—¶ç›®å½•å†…å®¹:"
          ls -la _temp/ || echo "ä¸´æ—¶ç›®å½•ä¸ºç©º"
          exit 1
        fi

    - name: Upload Final PDF
      uses: actions/upload-artifact@v4
      with:
        name: JavaScript-Guide-PDF
        path: _output/JavaScriptæƒå¨æŒ‡å—.pdf
        retention-days: 30

    - name: Upload All Generated Files
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: All-Generated-Files
        path: _output/
        retention-days: 7
