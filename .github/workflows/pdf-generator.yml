name: Generate PDF from Markdown

on:
  push:
    branches: [main, master]
  workflow_dispatch:

jobs:
  generate-pdf:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout Code
      uses: actions/checkout@v4
      with:
        submodules: recursive
        fetch-depth: 0

    - name: Setup Environment
      run: |
        mkdir -p _output
        echo "å·¥ä½œç›®å½•ç»“æ„:"
        find . -type f -name "*.md" | head -20

    - name: Install Dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          pandoc \
          texlive-xetex \
          texlive-latex-recommended \
          texlive-fonts-recommended \
          fonts-noto-cjk \
          fonts-noto-color-emoji \
          poppler-utils

    - name: Create Simple Markdown Index
      run: |
        echo "# JavaScriptæƒå¨æŒ‡å—ç¬¬ä¸ƒç‰ˆ" > _temp/complete.md
        echo "" >> _temp/complete.md
        echo "**ä½œè€…: Richard-Billyham**" >> _temp/complete.md
        echo "" >> _temp/complete.md
        echo "***" >> _temp/complete.md
        echo "" >> _temp/complete.md
        
        # æ·»åŠ  README.md å†…å®¹
        if [ -f "README.md" ]; then
          cat "README.md" >> _temp/complete.md
          echo "" >> _temp/complete.md
          echo "\\newpage" >> _temp/complete.md
          echo "" >> _temp/complete.md
        fi
        
        # æŸ¥æ‰¾å¹¶æ·»åŠ æ‰€æœ‰å…¶ä»– markdown æ–‡ä»¶
        find . -name "*.md" -type f \
          ! -path "./.git/*" \
          ! -path "./node_modules/*" \
          ! -path "./_output/*" \
          ! -path "./_temp/*" \
          ! -name "README.md" \
          ! -name "CONTRIBUTING.md" \
          ! -name "CHANGELOG.md" | sort -V > _temp/files.txt
        
        if [ -s "_temp/files.txt" ]; then
          while IFS= read -r file; do
            echo "æ·»åŠ : $file"
            echo "# $(basename "$file" .md)" >> _temp/complete.md
            echo "" >> _temp/complete.md
            cat "$file" >> _temp/complete.md
            echo "" >> _temp/complete.md
            echo "\\newpage" >> _temp/complete.md
            echo "" >> _temp/complete.md
          done < _temp/files.txt
        fi
        
        echo "åˆå¹¶å®Œæˆï¼Œæ–‡ä»¶å¤§å°:"
        ls -lh _temp/complete.md

    - name: Escape Special Characters
      run: |
        echo "è½¬ä¹‰ç‰¹æ®Šå­—ç¬¦..."
        # åˆ›å»ºå¤„ç†åçš„ç‰ˆæœ¬
        cp _temp/complete.md _temp/complete_escaped.md
        
        # ä½¿ç”¨ç®€å•çš„ sed å‘½ä»¤è½¬ä¹‰ LaTeX ç‰¹æ®Šå­—ç¬¦
        # æ³¨æ„ï¼šè¿™å¯èƒ½ä¼šå½±å“ä»£ç å—ï¼Œä½†ä¸ºäº†æˆåŠŸç¼–è¯‘ï¼Œæˆ‘ä»¬æš‚æ—¶æ¥å—
        sed -i 's/\\/\\\\textbackslash /g' _temp/complete_escaped.md
        sed -i 's/#/\\#/g' _temp/complete_escaped.md
        sed -i 's/\$/\\$/g' _temp/complete_escaped.md
        sed -i 's/%/\\%/g' _temp/complete_escaped.md
        sed -i 's/&/\\&/g' _temp/complete_escaped.md
        sed -i 's/_/\\_/g' _temp/complete_escaped.md
        sed -i 's/{/\\{/g' _temp/complete_escaped.md
        sed -i 's/}/\\}/g' _temp/complete_escaped.md
        sed -i 's/~/\\textasciitilde /g' _temp/complete_escaped.md
        sed -i 's/\^/\\textasciicircum /g' _temp/complete_escaped.md
        
        echo "è½¬ä¹‰å®Œæˆ"

    - name: Generate PDF with Minimal Settings
      run: |
        echo "ğŸ¯ ä½¿ç”¨æœ€å°åŒ–è®¾ç½®ç”ŸæˆPDF..."
        
        # æ–¹æ³•1: æœ€ç®€å•çš„pandocå‘½ä»¤
        pandoc _temp/complete_escaped.md -o _output/javascript-guide.pdf \
          --pdf-engine=xelatex \
          -V mainfont="Noto Sans CJK SC" \
          -V geometry:margin=2.5cm \
          -V papersize=a4 \
          --table-of-contents \
          --toc-depth=3
        
        echo "âœ… PDFç”Ÿæˆå®Œæˆ"

    - name: Alternative Method - Use Basic LaTeX Template
      if: failure()
      run: |
        echo "ğŸ”„ ä½¿ç”¨åŸºç¡€LaTeXæ¨¡æ¿..."
        
        # åˆ›å»ºåŸºç¡€LaTeXæ¨¡æ¿
        cat > _temp/template.tex << 'EOF'
        \documentclass[a4paper,12pt]{book}
        \usepackage{xeCJK}
        \setCJKmainfont{Noto Sans CJK SC}
        \usepackage{geometry}
        \geometry{a4paper, margin=2.5cm}
        \usepackage{hyperref}
        \hypersetup{
            colorlinks=true,
            linkcolor=blue,
            urlcolor=cyan,
            pdftitle={JavaScriptæƒå¨æŒ‡å—ç¬¬ä¸ƒç‰ˆ},
            pdfauthor={Richard-Billyham}
        }
        \usepackage{titlesec}
        \titleformat{\chapter}{\huge\bfseries}{\thechapter}{1em}{}
        \titleformat{\section}{\Large\bfseries}{\thesection}{1em}{}
        \titleformat{\subsection}{\large\bfseries}{\thesubsection}{1em}{}
        
        \begin{document}
        \maketitle
        \tableofcontents
        $body$
        \end{document}
        EOF
        
        # ä½¿ç”¨æ¨¡æ¿ç”ŸæˆPDF
        pandoc _temp/complete.md -o _output/javascript-guide-template.pdf \
          --template=_temp/template.tex \
          --pdf-engine=xelatex \
          --table-of-contents
        
        echo "âœ… æ¨¡æ¿æ–¹æ³•å®Œæˆ"

    - name: Final Attempt - HTML to PDF
      if: failure()
      run: |
        echo "ğŸ”„ æœ€ç»ˆå°è¯•ï¼šHTMLè½¬PDF..."
        
        # å…ˆç”ŸæˆHTML
        pandoc _temp/complete.md -o _temp/complete.html \
          --toc \
          --toc-depth=3
        
        # ç„¶åä½¿ç”¨weasyprintå°†HTMLè½¬ä¸ºPDFï¼ˆå¦‚æœå¯ç”¨ï¼‰
        if command -v weasyprint >/dev/null 2>&1; then
          weasyprint _temp/complete.html _output/javascript-guide-weasyprint.pdf
        else
          # å®‰è£…weasyprint
          sudo apt-get install -y python3-weasyprint || \
          pip3 install weasyprint || \
          (echo "æ— æ³•å®‰è£…weasyprintï¼Œè·³è¿‡æ­¤æ–¹æ³•" && exit 0)
          
          weasyprint _temp/complete.html _output/javascript-guide-weasyprint.pdf
        fi
        
        echo "âœ… HTMLè½¬PDFå®Œæˆ"

    - name: Last Resort - Use Docker with Prebuilt Environment
      if: failure()
      run: |
        echo "ğŸš€ ä½¿ç”¨Dockeré¢„æ„å»ºç¯å¢ƒ..."
        
        # ä½¿ç”¨pandoc/latexçš„Dockeré•œåƒ
        docker run --rm -v $(pwd):/data pandoc/latex \
          _temp/complete.md -o _output/javascript-guide-docker.pdf \
          --pdf-engine=xelatex \
          -V mainfont="Noto Serif" \
          --table-of-contents
        
        echo "âœ… Dockeræ–¹æ³•å®Œæˆ"

    - name: Verify and Upload Results
      run: |
        echo "ğŸ“Š æ£€æŸ¥ç”Ÿæˆç»“æœ..."
        
        # æ£€æŸ¥æ‰€æœ‰å¯èƒ½çš„è¾“å‡ºæ–‡ä»¶
        shopt -s nullglob
        for pdf in _output/*.pdf; do
          if [ -f "$pdf" ]; then
            size=$(stat -c%s "$pdf")
            echo "âœ… æ‰¾åˆ°: $pdf ($((size/1024/1024)) MB)"
          fi
        done
        
        # å¦‚æœæ²¡æœ‰æ‰¾åˆ°ä»»ä½•PDFï¼Œåˆ›å»ºé”™è¯¯æ ‡è®°
        if ! compgen -G "_output/*.pdf" > /dev/null; then
          echo "âŒ æ²¡æœ‰ç”Ÿæˆä»»ä½•PDFæ–‡ä»¶"
          echo "è°ƒè¯•ä¿¡æ¯:"
          echo "åŸå§‹æ–‡ä»¶å¤§å°: $(ls -lh _temp/complete.md)"
          echo "è½¬ä¹‰æ–‡ä»¶å¤§å°: $(ls -lh _temp/complete_escaped.md)"
          echo "å‰10è¡Œå†…å®¹:"
          head -10 _temp/complete.md
          exit 1
        fi

    - name: Upload PDF Artifact
      uses: actions/upload-artifact@v4
      with:
        name: JavaScript-Guide-PDF
        path: _output/*.pdf
        retention-days: 30
