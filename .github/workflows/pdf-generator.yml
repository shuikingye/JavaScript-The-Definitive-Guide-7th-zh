name: Generate PDF from Markdown

on:
  push:
    branches: [main, master]
  workflow_dispatch:

jobs:
  generate-pdf:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout Code
      uses: actions/checkout@v4
      with:
        submodules: recursive
        fetch-depth: 0

    - name: Setup Environment
      run: |
        mkdir -p _output _temp
        echo "å·¥ä½œç›®å½•ç»“æ„:"
        find . -type f -name "*.md" | head -20

    - name: Install Dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          pandoc \
          texlive-xetex \
          texlive-latex-recommended \
          texlive-latex-extra \
          texlive-fonts-recommended \
          texlive-fonts-extra \
          texlive-science \
          texlive-pictures \
          lmodern \
          fonts-noto-cjk \
          fonts-noto-color-emoji \
          poppler-utils  # ç”¨äº pdfinfo

    - name: Find and Combine All Markdown Files
      id: combine_files
      run: |
        echo "ğŸ” æŸ¥æ‰¾æ‰€æœ‰ Markdown æ–‡ä»¶..."
        
        # æŸ¥æ‰¾æ‰€æœ‰ markdown æ–‡ä»¶ï¼Œæ’é™¤æ— å…³ç›®å½•
        find . -name "*.md" -type f \
          ! -path "./.git/*" \
          ! -path "./node_modules/*" \
          ! -path "./_output/*" \
          ! -path "./_temp/*" \
          ! -name "README.md" \
          ! -name "CONTRIBUTING.md" \
          ! -name "CHANGELOG.md" > _temp/md_files.txt
        
        # å¦‚æœæœ‰ README.mdï¼Œæ”¾åœ¨æœ€å‰é¢
        if [ -f "README.md" ]; then
          echo "README.md" > _temp/combined.md
          echo "---" >> _temp/combined.md
          echo "" >> _temp/combined.md
        fi
        
        # æŒ‰æ•°å­—é¡ºåºæ’åºæ–‡ä»¶ï¼ˆå¦‚æœæ–‡ä»¶åä»¥æ•°å­—å¼€å¤´ï¼‰
        if [ -s "_temp/md_files.txt" ]; then
          echo "ğŸ“š æ‰¾åˆ°ä»¥ä¸‹ Markdown æ–‡ä»¶:"
          cat _temp/md_files.txt
          
          # å°è¯•æŒ‰æ•°å­—æ’åº
          cat _temp/md_files.txt | sort -V > _temp/sorted_files.txt
          
          # åˆå¹¶æ‰€æœ‰æ–‡ä»¶
          while IFS= read -r file; do
            if [ -f "$file" ]; then
              echo "æ·»åŠ æ–‡ä»¶: $file"
              cat "$file" >> _temp/combined.md
              echo "" >> _temp/combined.md
              echo "---" >> _temp/combined.md
              echo "" >> _temp/combined.md
            fi
          done < _temp/sorted_files.txt
        else
          # å¦‚æœæ²¡æœ‰å…¶ä»–æ–‡ä»¶ï¼Œåªä½¿ç”¨ README.md
          if [ -f "README.md" ]; then
            cp README.md _temp/combined.md
          else
            echo "âŒ æ²¡æœ‰æ‰¾åˆ°ä»»ä½• Markdown æ–‡ä»¶"
            exit 1
          fi
        fi
        
        echo "âœ… åˆå¹¶å®Œæˆï¼Œæ€»å¤§å°:"
        ls -lh _temp/combined.md
        echo "è¡Œæ•°ç»Ÿè®¡:"
        wc -l _temp/combined.md

    - name: Create LaTeX Header File
      run: |
        mkdir -p _temp
        cat > _temp/header.tex << 'EOFEND'
        \usepackage{titlesec}
        \usepackage{fancyhdr}
        \usepackage{xcolor}
        \usepackage{hyperref}
        \usepackage{bookmark}
        
        % ç« èŠ‚æ ‡é¢˜æ ·å¼
        \titleformat{\chapter}[display]
          {\normalfont\huge\bfseries\color{blue!70!black}}
          {\chaptertitlename\ \thechapter}{20pt}{\Huge}
        
        \titleformat{\section}
          {\normalfont\Large\bfseries\color{blue!60!black}}
          {\thesection}{1em}{}
        
        \titleformat{\subsection}
          {\normalfont\large\bfseries\color{blue!50!black}}
          {\thesubsection}{1em}{}
        
        % é¡µçœ‰é¡µè„šè®¾ç½®
        \pagestyle{fancy}
        \fancyhf{}
        \fancyhead[L]{\leftmark}
        \fancyhead[R]{\thepage}
        \renewcommand{\headrulewidth}{0.5pt}
        
        % è¶…é“¾æ¥è®¾ç½®
        \hypersetup{
          pdfauthor={Richard-Billyham},
          pdftitle={JavaScriptæƒå¨æŒ‡å—ç¬¬ä¸ƒç‰ˆ},
          pdfsubject={JavaScriptç¼–ç¨‹æŒ‡å—},
          pdfkeywords={JavaScript,ç¼–ç¨‹,æŒ‡å—},
          bookmarksnumbered=true,
          bookmarksopen=true,
          pdfstartview=FitH,
          linkcolor=blue,
          urlcolor=cyan,
          citecolor=green
        }
        
        % ä»£ç å—æ ·å¼
        \usepackage{listings}
        \usepackage{caption}
        \DeclareCaptionFont{white}{\color{white}}
        \DeclareCaptionFormat{listing}{\colorbox{gray}{\parbox{\textwidth}{#1#2#3}}}
        \captionsetup[lstlisting]{format=listing,labelfont=white,textfont=white}
        
        \lstset{
          backgroundcolor=\color{white},
          basicstyle=\footnotesize\ttfamily,
          breakatwhitespace=false,
          breaklines=true,
          captionpos=b,
          commentstyle=\color{green},
          extendedchars=true,
          frame=single,
          keepspaces=true,
          keywordstyle=\color{blue},
          numbers=left,
          numbersep=5pt,
          numberstyle=\tiny\color{gray},
          rulecolor=\color{black},
          showspaces=false,
          showstringspaces=false,
          showtabs=false,
          stepnumber=1,
          stringstyle=\color{red},
          tabsize=2
        }
        EOFEND

    - name: Generate PDF with All Content
      run: |
        WORKSPACE_PATH="${{ github.workspace }}"
        
        echo "ğŸ¯ å¼€å§‹ç”Ÿæˆå®Œæ•´PDF..."
        echo "è¾“å…¥æ–‡ä»¶å¤§å°: $(ls -lh _temp/combined.md)"
        
        # ç”ŸæˆPDF
        pandoc "_temp/combined.md" -o "_output/javascript-guide.pdf" \
          --metadata title="JavaScriptæƒå¨æŒ‡å—ç¬¬ä¸ƒç‰ˆ" \
          --metadata author="Richard-Billyham" \
          --table-of-contents \
          --toc-depth=3 \
          --number-sections \
          --pdf-engine=xelatex \
          -V mainfont="Noto Sans CJK SC" \
          -V sansfont="Noto Sans CJK SC" \
          -V monofont="Noto Sans Mono CJK SC" \
          -V geometry:margin=2.5cm \
          -V geometry:a4paper \
          -V colorlinks=true \
          -V linkcolor=blue \
          -V urlcolor=cyan \
          -V toccolor=blue \
          -V papersize=a4 \
          -V fontsize=11pt \
          -V linestretch=1.2 \
          -V secnumdepth=3 \
          --include-in-header="$WORKSPACE_PATH/_temp/header.tex" \
          --highlight-style=tango \
          --pdf-engine-opt=-shell-escape
        
        echo "âœ… PDFç”Ÿæˆå®Œæˆ"

    - name: Verify PDF Content
      run: |
        echo "ğŸ“Š éªŒè¯PDFæ–‡ä»¶..."
        if [ ! -f "_output/javascript-guide.pdf" ]; then
          echo "âŒ PDF æ–‡ä»¶ç”Ÿæˆå¤±è´¥"
          exit 1
        fi
        
        PDF_SIZE=$(stat -c%s "_output/javascript-guide.pdf")
        echo "PDF æ–‡ä»¶å¤§å°: $PDF_SIZE å­—èŠ‚"
        
        # æ£€æŸ¥PDFåŸºæœ¬ä¿¡æ¯
        if command -v pdfinfo >/dev/null 2>&1; then
          echo "ğŸ“„ PDF ä¿¡æ¯:"
          pdfinfo "_output/javascript-guide.pdf" || echo "æ— æ³•è¯»å–PDFè¯¦ç»†ä¿¡æ¯"
        else
          echo "ğŸ“„ PDF æ–‡ä»¶ä¿¡æ¯:"
          ls -lh "_output/javascript-guide.pdf"
        fi
        
        # å¤§å°æ£€æŸ¥ - å¦‚æœå°äº100KBï¼Œå¯èƒ½æœ‰é—®é¢˜
        if [ "$PDF_SIZE" -lt 102400 ]; then
          echo "âš ï¸  è­¦å‘Š: PDF æ–‡ä»¶å¯èƒ½å¤ªå°ï¼Œå†…å®¹å¯èƒ½ä¸å®Œæ•´"
          echo "è°ƒè¯•ä¿¡æ¯:"
          echo "åˆå¹¶çš„Markdownæ–‡ä»¶:"
          ls -lh _temp/combined.md
          echo "å‰100è¡Œå†…å®¹:"
          head -100 _temp/combined.md
          exit 1
        else
          echo "âœ… PDF æ–‡ä»¶å¤§å°æ­£å¸¸"
        fi

    - name: Upload PDF Artifact
      uses: actions/upload-artifact@v4
      with:
        name: JavaScript-Guide-PDF
        path: _output/javascript-guide.pdf
        retention-days: 30

    - name: Upload to GitHub Releases
      if: startsWith(github.ref, 'refs/tags/')
      uses: softprops/action-gh-release@v1
      with:
        files: _output/javascript-guide.pdf
