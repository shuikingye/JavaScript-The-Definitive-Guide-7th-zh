name: Generate PDF from Markdown
on:
  push:
    branches: [main, master]
  workflow_dispatch:  # å…è®¸æ‰‹åŠ¨è§¦å‘

jobs:
  generate-pdf:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout Code
      uses: actions/checkout@v4
      with:
        # ç¡®ä¿æ£€å‡ºæ‰€æœ‰æ–‡ä»¶ï¼ŒåŒ…æ‹¬å­æ¨¡å—ï¼ˆå¦‚æœæœ‰ï¼‰
        submodules: recursive
        fetch-depth: 0

    - name: Setup Environment
      run: |
        # åˆ›å»ºå¿…è¦çš„ç›®å½•ç»“æ„
        mkdir -p _output _temp

    - name: Install Dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          pandoc \
          texlive-xetex \
          texlive-latex-recommended \
          texlive-latex-extra \
          texlive-fonts-recommended \
          texlive-fonts-extra \
          texlive-science \
          texlive-pictures \
          lmodern \
          fonts-noto-cjk \
          fonts-noto-color-emoji

    - name: Check Markdown Files
      run: |
        echo "ğŸ“ é¡¹ç›®ç»“æ„:"
        find . -name "*.md" -type f | head -20
        echo ""
        echo "ğŸ“„ Markdown æ–‡ä»¶ç»Ÿè®¡:"
        find . -name "*.md" -type f | wc -l
        
        # æ£€æŸ¥ä¸»æ–‡ä»¶æ˜¯å¦å­˜åœ¨
        if [ ! -f "README.md" ] && [ ! -f "main.md" ] && [ ! -f "index.md" ]; then
          echo "âŒ æœªæ‰¾åˆ°ä¸»è¦çš„ Markdown æ–‡ä»¶ (README.md, main.md, index.md)"
          # å¯»æ‰¾å¯èƒ½çš„å…¥å£æ–‡ä»¶
          ENTRY_FILE=$(find . -name "*.md" -type f | head -1)
          if [ -n "$ENTRY_FILE" ]; then
            echo "ğŸ’¡ å»ºè®®ä½¿ç”¨: $ENTRY_FILE"
          fi
          exit 1
        fi

    - name: Find and Prepare Markdown Files
      id: prepare_files
      run: |
        # ç¡®å®šå…¥å£æ–‡ä»¶
        if [ -f "README.md" ]; then
          ENTRY_FILE="README.md"
        elif [ -f "main.md" ]; then
          ENTRY_FILE="main.md"
        elif [ -f "index.md" ]; then
          ENTRY_FILE="index.md"
        else
          ENTRY_FILE=$(find . -name "*.md" -type f | head -1)
        fi
        
        echo "ğŸ“– ä½¿ç”¨å…¥å£æ–‡ä»¶: $ENTRY_FILE"
        
        # æ”¶é›†æ‰€æœ‰ Markdown æ–‡ä»¶ï¼ˆæ’é™¤ä¸éœ€è¦çš„ï¼‰
        find . -name "*.md" -type f \
          ! -path "./.git/*" \
          ! -path "./node_modules/*" \
          ! -path "./_output/*" \
          ! -path "./_temp/*" \
          | sort > _temp/file_list.txt
        
        echo "ğŸ“‹ æ‰¾åˆ°çš„ Markdown æ–‡ä»¶:"
        cat _temp/file_list.txt
        
        # è®¾ç½®è¾“å‡ºå˜é‡
        echo "entry_file=$ENTRY_FILE" >> $GITHUB_OUTPUT

    - name: Generate PDF with Enhanced Styling
      run: |
        # åˆ›å»ºè‡ªå®šä¹‰æ¨¡æ¿æˆ–ä½¿ç”¨å¢å¼ºå‚æ•°
        pandoc "${{ steps.prepare_files.outputs.entry_file }}" -o "_output/JavaScriptæƒå¨æŒ‡å—.pdf" \
          --metadata title="JavaScriptæƒå¨æŒ‡å—ç¬¬ä¸ƒç‰ˆ" \
          --metadata author="Richard-Billyham" \
          --table-of-contents \
          --toc-depth=3 \
          --number-sections \
          --pdf-engine=xelatex \
          -V mainfont="Noto Sans CJK SC" \
          -V sansfont="Noto Sans CJK SC" \
          -V monofont="Noto Sans Mono CJK SC" \
          -V geometry:margin=2.5cm \
          -V geometry:a4paper \
          -V colorlinks=true \
          -V linkcolor=blue \
          -V urlcolor=cyan \
          -V toccolor=blue \
          -V papersize=a4 \
          -V fontsize=11pt \
          -V linestretch=1.2 \
          --include-in-header=_temp/header.tex \
          --highlight-style=tango

    - name: Create Custom Header (Enhanced Styling)
      run: |
        cat > _temp/header.tex << 'EOF'
        \usepackage{titlesec}
        \usepackage{fancyhdr}
        
        % ç« èŠ‚æ ‡é¢˜æ ·å¼
        \titleformat{\chapter}[display]
          {\normalfont\huge\bfseries\color{blue!70!black}}
          {\chaptertitlename\ \thechapter}{20pt}{\Huge}
        
        \titleformat{\section}
          {\normalfont\Large\bfseries\color{blue!60!black}}
          {\thesection}{1em}{}
        
        \titleformat{\subsection}
          {\normalfont\large\bfseries\color{blue!50!black}}
          {\thesubsection}{1em}{}
        
        % é¡µçœ‰é¡µè„š
        \pagestyle{fancy}
        \fancyhf{}
        \fancyhead[L]{\leftmark}
        \fancyhead[R]{\thepage}
        \renewcommand{\headrulewidth}{0.5pt}
        
        % ä»£ç å—æ ·å¼å¢å¼º
        \usepackage{minted}
        \usemintedstyle{vs}
        
        % é“¾æ¥æ ·å¼
        \usepackage{hyperref}
        \hypersetup{
          pdfauthor={Richard-Billyham},
          pdftitle={JavaScriptæƒå¨æŒ‡å—ç¬¬ä¸ƒç‰ˆ},
          pdfsubject={JavaScriptç¼–ç¨‹æŒ‡å—},
          pdfkeywords={JavaScript,ç¼–ç¨‹,æŒ‡å—}
        }
        EOF

    - name: Verify PDF Generation
      run: |
        if [ ! -f "_output/JavaScriptæƒå¨æŒ‡å—.pdf" ]; then
          echo "âŒ PDF æ–‡ä»¶ç”Ÿæˆå¤±è´¥"
          exit 1
        else
          echo "âœ… PDF æ–‡ä»¶ç”ŸæˆæˆåŠŸ"
          ls -la "_output/JavaScriptæƒå¨æŒ‡å—.pdf"
        fi

    - name: Upload PDF Artifact
      uses: actions/upload-artifact@v4
      with:
        name: JavaScriptæƒå¨æŒ‡å—
        path: _output/JavaScriptæƒå¨æŒ‡å—.pdf
        retention-days: 30

    - name: Upload to GitHub Releases (Optional)
      if: startsWith(github.ref, 'refs/tags/')
      uses: softprops/action-gh-release@v1
      with:
        files: _output/JavaScriptæƒå¨æŒ‡å—.pdf
