name: Generate PDF from JavaScript Guide

on:
  push:
    branches: [main, master]
  workflow_dispatch:

jobs:
  generate-pdf:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout Code
      uses: actions/checkout@v4
      with:
        submodules: recursive
        fetch-depth: 0

    - name: Setup Environment
      run: |
        echo "ğŸ“ è®¾ç½®å·¥ä½œç¯å¢ƒ..."
        mkdir -p _output _temp
        echo "å½“å‰ç›®å½•: $(pwd)"

    - name: Install Dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          pandoc \
          texlive-xetex \
          texlive-latex-recommended \
          texlive-fonts-recommended \
          fonts-noto-cjk \
          fonts-noto-color-emoji \
          poppler-utils \
          python3

    - name: Advanced Preprocessing with Python
      run: |
        echo "ğŸ”§ ä½¿ç”¨Pythonè¿›è¡Œé«˜çº§é¢„å¤„ç†..."
        
        # åˆ›å»ºPythonè„šæœ¬æ¥å¤„ç†è½¬ä¹‰åºåˆ—
        cat > _temp/preprocess.py << 'EOF'
        import re
        import sys
        
        def escape_latex_special_chars(text):
            # LaTeXç‰¹æ®Šå­—ç¬¦è½¬ä¹‰æ˜ å°„
            escape_map = {
                '\\': '\\\\textbackslash{}',
                '#': '\\#',
                '$': '\\$',
                '%': '\\%',
                '&': '\\&',
                '_': '\\_',
                '{': '\\{',
                '}': '\\}',
                '~': '\\textasciitilde{}',
                '^': '\\textasciicircum{}',
                '<': '\\textless{}',
                '>': '\\textgreater{}',
                '|': '\\textbar{}'
            }
            
            # é¦–å…ˆå¤„ç†ä»£ç å—ä¸­çš„è½¬ä¹‰åºåˆ—
            lines = text.split('\n')
            in_code_block = False
            processed_lines = []
            
            for line in lines:
                # æ£€æµ‹ä»£ç å—å¼€å§‹/ç»“æŸ
                if line.strip().startswith('```'):
                    in_code_block = not in_code_block
                    processed_lines.append(line)
                    continue
                
                if in_code_block:
                    # åœ¨ä»£ç å—ä¸­ï¼Œç‰¹åˆ«å¤„ç†è½¬ä¹‰åºåˆ—
                    # å°† \n æ›¿æ¢ä¸º \\nï¼Œ\t æ›¿æ¢ä¸º \\t ç­‰
                    line = line.replace('\\n', '\\\\n')
                    line = line.replace('\\t', '\\\\t')
                    line = line.replace('\\r', '\\\\r')
                    line = line.replace('\\"', '\\\\"')
                    line = line.replace("\\'", "\\\\'")
                    line = line.replace('\\`', '\\\\`')
                    processed_lines.append(line)
                else:
                    # åœ¨æ™®é€šæ–‡æœ¬ä¸­ï¼Œè½¬ä¹‰æ‰€æœ‰LaTeXç‰¹æ®Šå­—ç¬¦
                    for char, escaped in escape_map.items():
                        line = line.replace(char, escaped)
                    processed_lines.append(line)
            
            return '\n'.join(processed_lines)
        
        # è¯»å–åŸå§‹æ–‡ä»¶
        with open('_temp/complete.md', 'r', encoding='utf-8') as f:
            content = f.read()
        
        # å¤„ç†å†…å®¹
        processed_content = escape_latex_special_chars(content)
        
        # ä¿å­˜å¤„ç†åçš„å†…å®¹
        with open('_temp/complete_processed.md', 'w', encoding='utf-8') as f:
            f.write(processed_content)
        
        print("âœ… Pythoné¢„å¤„ç†å®Œæˆ")
        EOF
        
        # è¿è¡ŒPythoné¢„å¤„ç†è„šæœ¬
        python3 _temp/preprocess.py

    - name: Create Structured Markdown File
      run: |
        echo "ğŸ“ åˆ›å»ºç»“æ„åŒ–Markdownæ–‡ä»¶..."
        
        # åˆ›å»ºå°é¢å’Œç›®å½•
        cat > _temp/complete.md << 'EOF'
        # JavaScriptæƒå¨æŒ‡å—ç¬¬ä¸ƒç‰ˆ
        
        **ä½œè€…: Richard-Billyham**
        
        **ç”Ÿæˆæ—¶é—´: $(date)**
        
        ***
        
        ## ç›®å½•
        
        EOF
        
        # æ·»åŠ README.mdå†…å®¹
        if [ -f "README.md" ]; then
          echo "æ·»åŠ ç®€ä»‹..."
          echo "# ç®€ä»‹" >> _temp/complete.md
          echo "" >> _temp/complete.md
          cat "README.md" >> _temp/complete.md
          echo "" >> _temp/complete.md
          echo "\\newpage" >> _temp/complete.md
          echo "" >> _temp/complete.md
        fi
        
        # æŒ‰æ­£ç¡®é¡ºåºæ·»åŠ ç« èŠ‚
        chapters=(
          "./docs/ch1.md"
          "./docs/ch2.md" 
          "./docs/ch3.md"
          "./docs/ch4.md"
          "./docs/ch5.md"
          "./docs/ch6.md"
          "./docs/ch7.md"
          "./docs/ch8.md"
          "./docs/ch9.md"
          "./docs/ch10.md"
          "./docs/ch11.md"
          "./docs/ch12.md"
          "./docs/ch13.md"
          "./docs/ch14.md"
          "./docs/ch15.md"
          "./docs/ch16.md"
          "./docs/ch17.md"
        )
        
        for chapter in "${chapters[@]}"; do
          if [ -f "$chapter" ]; then
            echo "æ·»åŠ ç« èŠ‚: $chapter"
            # æå–ç« èŠ‚æ ‡é¢˜
            title=$(basename "$chapter" .md | sed 's/ch/ç¬¬/' | sed 's/$/ç« /')
            echo "# $title" >> _temp/complete.md
            echo "" >> _temp/complete.md
            cat "$chapter" >> _temp/complete.md
            echo "" >> _temp/complete.md
            echo "\\newpage" >> _temp/complete.md
            echo "" >> _temp/complete.md
          else
            echo "âš ï¸  ç« èŠ‚ä¸å­˜åœ¨: $chapter"
          fi
        done
        
        echo "âœ… æ–‡ä»¶åˆ›å»ºå®Œæˆ"
        echo "åŸå§‹æ–‡ä»¶å¤§å°: $(ls -lh _temp/complete.md)"
        echo "å¤„ç†åæ–‡ä»¶å¤§å°: $(ls -lh _temp/complete_processed.md)"

    - name: Debug Problematic Lines
      run: |
        echo "ğŸ› è°ƒè¯•é—®é¢˜è¡Œ..."
        echo "æ£€æŸ¥ç¬¬2120-2130è¡Œ:"
        if [ -f "_temp/complete_processed.md" ]; then
          sed -n '2120,2130p' _temp/complete_processed.md
        fi
        echo ""
        echo "æ£€æŸ¥ç¬¬2150-2165è¡Œ:"
        if [ -f "_temp/complete_processed.md" ]; then
          sed -n '2150,2165p' _temp/complete_processed.md
        fi

    - name: Create Ultimate LaTeX Header
      run: |
        echo "ğŸ“„ åˆ›å»ºç»ˆæLaTeXå¤´æ–‡ä»¶..."
        
        cat > _temp/header.tex << 'EOF'
        \usepackage{fontspec}
        \setmainfont{Noto Sans CJK SC}
        \usepackage{geometry}
        \geometry{a4paper, margin=2.5cm}
        \usepackage{titlesec}
        \usepackage{fancyhdr}
        \usepackage{xcolor}
        \usepackage{hyperref}
        \usepackage{listings}
        \usepackage{upquote}
        
        % ç« èŠ‚æ ·å¼
        \titleformat{\chapter}
          {\normalfont\Huge\bfseries}{\thechapter}{1em}{}
        \titleformat{\section}
          {\normalfont\Large\bfseries}{\thesection}{1em}{}
          
        % é¡µçœ‰é¡µè„š
        \pagestyle{fancy}
        \fancyhf{}
        \fancyhead[L]{\leftmark}
        \fancyhead[R]{\thepage}
        
        % è¶…é“¾æ¥è®¾ç½®
        \hypersetup{
          colorlinks=true,
          linkcolor=blue,
          urlcolor=cyan,
          pdftitle={JavaScriptæƒå¨æŒ‡å—ç¬¬ä¸ƒç‰ˆ},
          pdfauthor={Richard-Billyham}
        }
        
        % ç»ˆæä»£ç å—å¤„ç† - ä½¿ç”¨æœ€å®‰å…¨çš„è®¾ç½®
        \lstset{
          basicstyle=\ttfamily\small,
          breaklines=true,
          frame=single,
          backgroundcolor=\color{gray!5},
          upquote=true,
          showstringspaces=false,
          literate=%
          {\\}{{\textbackslash}}1%
          {\n}{{\textbackslash n}}1%
          {\t}{{\textbackslash t}}1%
          {\r}{{\textbackslash r}}1%
        }
        
        % å®šä¹‰JavaScriptè¯­è¨€
        \lstdefinelanguage{JavaScript}{
          keywords={typeof, new, true, false, catch, function, return, null, catch, switch, var, if, in, while, do, else, case, break},
          keywordstyle=\color{blue}\bfseries,
          ndkeywords={class, export, boolean, throw, implements, import, this},
          ndkeywordstyle=\color{darkgray}\bfseries,
          identifierstyle=\color{black},
          sensitive=false,
          comment=[l]{//},
          morecomment=[s]{/*}{*/},
          commentstyle=\color{purple}\ttfamily,
          stringstyle=\color{red}\ttfamily
        }
        EOF

    - name: Generate PDF - Method 1 (Processed Content)
      run: |
        echo "ğŸ¯ æ–¹æ³•1: ä½¿ç”¨é¢„å¤„ç†å†…å®¹ç”ŸæˆPDF..."
        
        pandoc "_temp/complete_processed.md" -o "_output/method1-processed.pdf" \
          --pdf-engine=xelatex \
          -V mainfont="Noto Sans CJK SC" \
          -V geometry:margin=2.5cm \
          -V papersize=a4 \
          --table-of-contents \
          --toc-depth=3 \
          -M title="JavaScriptæƒå¨æŒ‡å—ç¬¬ä¸ƒç‰ˆ" \
          -M author="Richard-Billyham"
        
        echo "âœ… æ–¹æ³•1å®Œæˆ"

    - name: Generate PDF - Method 2 (With Listings)
      if: failure()
      run: |
        echo "ğŸ¯ æ–¹æ³•2: ä½¿ç”¨listingsåŒ…ç”ŸæˆPDF..."
        
        pandoc "_temp/complete_processed.md" -o "_output/method2-listings.pdf" \
          --pdf-engine=xelatex \
          --include-in-header="${{ github.workspace }}/_temp/header.tex" \
          --listings \
          --table-of-contents \
          --toc-depth=3 \
          -M title="JavaScriptæƒå¨æŒ‡å—ç¬¬ä¸ƒç‰ˆ" \
          -M author="Richard-Billyham"
        
        echo "âœ… æ–¹æ³•2å®Œæˆ"

    - name: Generate PDF - Method 3 (No Code Blocks)
      if: failure()
      run: |
        echo "ğŸ¯ æ–¹æ³•3: ç§»é™¤ä»£ç å—ç”ŸæˆPDF..."
        
        # åˆ›å»ºæ²¡æœ‰ä»£ç å—çš„ç‰ˆæœ¬
        python3 << 'EOF'
        import re
        
        with open('_temp/complete.md', 'r', encoding='utf-8') as f:
            content = f.read()
        
        # ç§»é™¤æ‰€æœ‰ä»£ç å—
        content = re.sub(r'```.*?```', 'ã€ä»£ç å—å·²ç§»é™¤ã€‘', content, flags=re.DOTALL)
        
        with open('_temp/complete_no_code.md', 'w', encoding='utf-8') as f:
            f.write(content)
        
        print("âœ… ä»£ç å—ç§»é™¤å®Œæˆ")
        EOF
        
        pandoc "_temp/complete_no_code.md" -o "_output/method3-no-code.pdf" \
          --pdf-engine=xelatex \
          -V mainfont="Noto Sans CJK SC" \
          -V geometry:margin=2.5cm \
          -V papersize=a4 \
          --table-of-contents \
          --toc-depth=3
        
        echo "âœ… æ–¹æ³•3å®Œæˆ"

    - name: Generate PDF - Method 4 (Split by Chapter)
      if: failure()
      run: |
        echo "ğŸ¯ æ–¹æ³•4: åˆ†ç« èŠ‚ç”ŸæˆPDF..."
        
        # ä¸ºæ¯ä¸ªç« èŠ‚å•ç‹¬ç”ŸæˆPDF
        chapters=(
          "./docs/ch1.md" "./docs/ch2.md" "./docs/ch3.md" "./docs/ch4.md" "./docs/ch5.md"
          "./docs/ch6.md" "./docs/ch7.md" "./docs/ch8.md" "./docs/ch9.md" "./docs/ch10.md"
          "./docs/ch11.md" "./docs/ch12.md" "./docs/ch13.md" "./docs/ch14.md" "./docs/ch15.md"
          "./docs/ch16.md" "./docs/ch17.md"
        )
        
        success_count=0
        for chapter in "${chapters[@]}"; do
          if [ -f "$chapter" ]; then
            chapter_name=$(basename "$chapter" .md)
            echo "ç”Ÿæˆ: $chapter_name.pdf"
            
            # ä¸ºæ¯ä¸ªç« èŠ‚åˆ›å»ºå•ç‹¬çš„å¤„ç†ç‰ˆæœ¬
            python3 << EOF
            import re
            
            with open('$chapter', 'r', encoding='utf-8') as f:
                content = f.read()
            
            # è½¬ä¹‰å¤„ç†
            def escape_latex(text):
                escape_map = {'\\\\': '\\\\\\\\textbackslash{}', '#': '\\\\#', '$': '\\\\$', '%': '\\\\%', '&': '\\\\&', '_': '\\\\_', '{': '\\\\{', '}': '\\\\}', '~': '\\\\textasciitilde{}', '^': '\\\\textasciicircum{}'}
                for char, escaped in escape_map.items():
                    text = text.replace(char, escaped)
                text = text.replace('\\\\n', '\\\\\\\\n')
                text = text.replace('\\\\t', '\\\\\\\\t')
                return text
            
            processed = escape_latex(content)
            with open('_temp/${chapter_name}_processed.md', 'w', encoding='utf-8') as f:
                f.write(processed)
            EOF
            
            if pandoc "_temp/${chapter_name}_processed.md" -o "_output/${chapter_name}.pdf" \
              --pdf-engine=xelatex \
              -V mainfont="Noto Sans CJK SC" \
              -V geometry:margin=2.5cm 2>/dev/null; then
              echo "âœ… $chapter_name ç”ŸæˆæˆåŠŸ"
              success_count=$((success_count+1))
            else
              echo "âŒ $chapter_name ç”Ÿæˆå¤±è´¥"
            fi
          fi
        done
        
        echo "åˆ†ç« èŠ‚ç”Ÿæˆå®Œæˆ: $success_count/17 æˆåŠŸ"

    - name: Check and Upload Results
      run: |
        echo "ğŸ“Š æ£€æŸ¥ç”Ÿæˆç»“æœ..."
        
        # æ£€æŸ¥æ‰€æœ‰PDFæ–‡ä»¶
        pdf_files=()
        for pdf in _output/*.pdf; do
          if [ -f "$pdf" ]; then
            size=$(stat -c%s "$pdf")
            if [ $size -gt 10240 ]; then  # å¤§äº10KB
              echo "âœ… æœ‰æ•ˆPDF: $pdf ($((size/1024)) KB)"
              pdf_files+=("$pdf")
            else
              echo "âš ï¸  å°æ–‡ä»¶: $pdf ($((size/1024)) KB)"
            fi
          fi
        done
        
        if [ ${#pdf_files[@]} -eq 0 ]; then
          echo "âŒ æ²¡æœ‰ç”Ÿæˆæœ‰æ•ˆçš„PDFæ–‡ä»¶"
          echo "è°ƒè¯•ä¿¡æ¯:"
          echo "é—®é¢˜åŒºåŸŸå†…å®¹:"
          if [ -f "_temp/complete_processed.md" ]; then
            echo "ç¬¬2120-2130è¡Œ:"
            sed -n '2120,2130p' _temp/complete_processed.md
          fi
          exit 1
        else
          echo "ğŸ‰ æˆåŠŸç”Ÿæˆ ${#pdf_files[@]} ä¸ªPDFæ–‡ä»¶"
        fi

    - name: Upload PDF Artifacts
      uses: actions/upload-artifact@v4
      with:
        name: JavaScript-Guide-PDF
        path: _output/*.pdf
        retention-days: 30
