name: Generate PDF from Markdown

on:
  push:
    branches: [main, master]
  workflow_dispatch:

jobs:
  generate-pdf:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout Code
      uses: actions/checkout@v4
      with:
        submodules: recursive
        fetch-depth: 0

    - name: Setup Environment
      run: |
        mkdir -p _output _temp
        echo "å·¥ä½œç›®å½•ç»“æ„:"
        find . -type f -name "*.md" | head -20

    - name: Install Dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          pandoc \
          texlive-xetex \
          texlive-latex-recommended \
          texlive-latex-extra \
          texlive-fonts-recommended \
          texlive-fonts-extra \
          texlive-science \
          texlive-pictures \
          texlive-luatex \
          lmodern \
          fonts-noto-cjk \
          fonts-noto-color-emoji \
          poppler-utils

    - name: Find and Combine All Markdown Files
      id: combine_files
      run: |
        echo "ğŸ” æŸ¥æ‰¾æ‰€æœ‰ Markdown æ–‡ä»¶..."
        
        # æŸ¥æ‰¾æ‰€æœ‰ markdown æ–‡ä»¶ï¼Œæ’é™¤æ— å…³ç›®å½•
        find . -name "*.md" -type f \
          ! -path "./.git/*" \
          ! -path "./node_modules/*" \
          ! -path "./_output/*" \
          ! -path "./_temp/*" \
          ! -name "README.md" \
          ! -name "CONTRIBUTING.md" \
          ! -name "CHANGELOG.md" > _temp/md_files.txt
        
        # åˆ›å»ºåˆå¹¶æ–‡ä»¶
        if [ -f "README.md" ]; then
          echo "ä½¿ç”¨ README.md ä½œä¸ºå¼€å¤´"
          cp README.md _temp/combined.md
          echo "" >> _temp/combined.md
          echo "\\newpage" >> _temp/combined.md
          echo "" >> _temp/combined.md
        else
          touch _temp/combined.md
        fi
        
        # æŒ‰æ•°å­—é¡ºåºæ’åºæ–‡ä»¶
        if [ -s "_temp/md_files.txt" ]; then
          echo "ğŸ“š æ‰¾åˆ°ä»¥ä¸‹ Markdown æ–‡ä»¶:"
          cat _temp/md_files.txt
          
          # æŒ‰æ•°å­—æ’åº
          sort -V _temp/md_files.txt > _temp/sorted_files.txt
          
          # åˆå¹¶æ‰€æœ‰æ–‡ä»¶
          while IFS= read -r file; do
            if [ -f "$file" ]; then
              echo "æ·»åŠ æ–‡ä»¶: $file"
              echo "# $(basename "$file" .md)" >> _temp/combined.md
              echo "" >> _temp/combined.md
              cat "$file" >> _temp/combined.md
              echo "" >> _temp/combined.md
              echo "\\newpage" >> _temp/combined.md
              echo "" >> _temp/combined.md
            fi
          done < _temp/sorted_files.txt
        else
          echo "âš ï¸ æ²¡æœ‰æ‰¾åˆ°å…¶ä»– Markdown æ–‡ä»¶"
        fi
        
        echo "âœ… åˆå¹¶å®Œæˆï¼Œæ€»å¤§å°:"
        ls -lh _temp/combined.md
        echo "è¡Œæ•°ç»Ÿè®¡:"
        wc -l _temp/combined.md

    - name: Preprocess Markdown for LaTeX Compatibility
      run: |
        echo "ğŸ”§ é¢„å¤„ç† Markdown æ–‡ä»¶ä»¥å…¼å®¹ LaTeX..."
        
        # å¤‡ä»½åŸå§‹æ–‡ä»¶
        cp _temp/combined.md _temp/combined_backup.md
        
        # è½¬ä¹‰ LaTeX ç‰¹æ®Šå­—ç¬¦
        sed -i 's/\\/\\\\textbackslash /g' _temp/combined.md
        sed -i 's/#/\\#/g' _temp/combined.md
        sed -i 's/\$/\\$/g' _temp/combined.md
        sed -i 's/%/\\%/g' _temp/combined.md
        sed -i 's/&/\\&/g' _temp/combined.md
        sed -i 's/_/\\_/g' _temp/combined.md
        sed -i 's/{/\\{/g' _temp/combined.md
        sed -i 's/}/\\}/g' _temp/combined.md
        sed -i 's/~/\\textasciitilde /g' _temp/combined.md
        sed -i 's/\^/\\textasciicircum /g' _temp/combined.md
        
        # ç‰¹åˆ«å¤„ç† \n å’Œå…¶ä»–è½¬ä¹‰åºåˆ—
        sed -i 's/\\n/\\\\n/g' _temp/combined.md
        sed -i 's/\\t/\\\\t/g' _temp/combined.md
        sed -i 's/\\r/\\\\r/g' _temp/combined.md
        
        echo "âœ… é¢„å¤„ç†å®Œæˆ"

    - name: Debug Problematic Section
      run: |
        echo "ğŸ› è°ƒè¯•é—®é¢˜åŒºåŸŸ (ç¬¬2100-2110è¡Œ):"
        if [ -f "_temp/combined.md" ]; then
          sed -n '2100,2110p' _temp/combined.md
        fi

    - name: Create Robust LaTeX Header
      run: |
        mkdir -p _temp
        cat > _temp/header.tex << 'EOFEND'
        \usepackage{titlesec}
        \usepackage{fancyhdr}
        \usepackage{xcolor}
        \usepackage{hyperref}
        \usepackage{bookmark}
        \usepackage{listings}
        \usepackage{minted}
        
        % é˜²æ­¢ä»£ç å—ä¸­çš„ç‰¹æ®Šå­—ç¬¦å‡ºé”™
        \usepackage[utf8]{inputenc}
        \usepackage{upquote} % ç¡®ä¿å¼•å·æ­£ç¡®å¤„ç†
        
        % ç« èŠ‚æ ‡é¢˜æ ·å¼
        \titleformat{\chapter}[display]
          {\normalfont\huge\bfseries\color{blue!70!black}}
          {\chaptertitlename\ \thechapter}{20pt}{\Huge}
        
        \titleformat{\section}
          {\normalfont\Large\bfseries\color{blue!60!black}}
          {\thesection}{1em}{}
        
        \titleformat{\subsection}
          {\normalfont\large\bfseries\color{blue!50!black}}
          {\thesubsection}{1em}{}
        
        % é¡µçœ‰é¡µè„šè®¾ç½®
        \pagestyle{fancy}
        \fancyhf{}
        \fancyhead[L]{\leftmark}
        \fancyhead[R]{\thepage}
        \renewcommand{\headrulewidth}{0.5pt}
        
        % è¶…é“¾æ¥è®¾ç½®
        \hypersetup{
          pdfauthor={Richard-Billyham},
          pdftitle={JavaScriptæƒå¨æŒ‡å—ç¬¬ä¸ƒç‰ˆ},
          pdfsubject={JavaScriptç¼–ç¨‹æŒ‡å—},
          pdfkeywords={JavaScript,ç¼–ç¨‹,æŒ‡å—},
          bookmarksnumbered=true,
          bookmarksopen=true,
          pdfstartview=FitH,
          linkcolor=blue,
          urlcolor=cyan,
          citecolor=green
        }
        
        % ä»£ç åˆ—è¡¨è®¾ç½® - æ›´å…¼å®¹çš„è®¾ç½®
        \lstset{
          basicstyle=\ttfamily\footnotesize,
          breaklines=true,
          frame=single,
          backgroundcolor=\color{gray!5},
          captionpos=b,
          abovecaptionskip=10pt,
          belowcaptionskip=10pt,
          xleftmargin=10pt,
          xrightmargin=10pt,
          escapeinside={\%*}{*)}, % å…è®¸åœ¨ä»£ç ä¸­æ’å…¥LaTeX
          upquote=true, % ç¡®ä¿ç›´å¼•å·
          showstringspaces=false
        }
        
        % å¤„ç†å†…è”ä»£ç 
        \newcommand{\code}[1]{\texttt{#1}}
        EOFEND

    - name: Generate PDF with Robust Settings
      run: |
        WORKSPACE_PATH="${{ github.workspace }}"
        
        echo "ğŸ¯ å¼€å§‹ç”ŸæˆPDF (ä½¿ç”¨æ›´ç¨³å¥çš„è®¾ç½®)..."
        echo "è¾“å…¥æ–‡ä»¶å¤§å°: $(ls -lh _temp/combined.md)"
        
        # ä½¿ç”¨æ›´ç¨³å¥çš„pandocè®¾ç½®
        pandoc "_temp/combined.md" -o "_output/javascript-guide.pdf" \
          --metadata title="JavaScriptæƒå¨æŒ‡å—ç¬¬ä¸ƒç‰ˆ" \
          --metadata author="Richard-Billyham" \
          --table-of-contents \
          --toc-depth=3 \
          --number-sections \
          --pdf-engine=xelatex \
          -V mainfont="Noto Sans CJK SC" \
          -V sansfont="Noto Sans CJK SC" \
          -V monofont="Noto Sans Mono CJK SC" \
          -V geometry:margin=2.5cm \
          -V geometry:a4paper \
          -V colorlinks=true \
          -V linkcolor=blue \
          -V urlcolor=cyan \
          -V toccolor=blue \
          -V papersize=a4 \
          -V fontsize=11pt \
          -V linestretch=1.2 \
          -V secnumdepth=3 \
          --include-in-header="$WORKSPACE_PATH/_temp/header.tex" \
          --highlight-style=pygments \
          --listings \
          -f markdown+smart \
          --wrap=auto
        
        echo "âœ… PDFç”Ÿæˆå‘½ä»¤æ‰§è¡Œå®Œæˆ"

    - name: Fallback PDF Generation (if main method fails)
      if: failure()
      run: |
        echo "ğŸ”„ å°è¯•å¤‡ç”¨PDFç”Ÿæˆæ–¹æ³•..."
        WORKSPACE_PATH="${{ github.workspace }}"
        
        # ç®€åŒ–è®¾ç½®ï¼Œé¿å…å¤æ‚ç‰¹æ€§
        pandoc "_temp/combined_backup.md" -o "_output/javascript-guide-simple.pdf" \
          --metadata title="JavaScriptæƒå¨æŒ‡å—ç¬¬ä¸ƒç‰ˆ" \
          --metadata author="Richard-Billyham" \
          --table-of-contents \
          --toc-depth=2 \
          --pdf-engine=xelatex \
          -V mainfont="Noto Sans CJK SC" \
          -V geometry:margin=2.5cm \
          -V geometry:a4paper \
          -V papersize=a4 \
          -V fontsize=11pt \
          --highlight-style=kate
        
        echo "âœ… å¤‡ç”¨PDFç”Ÿæˆå®Œæˆ"

    - name: Verify PDF Generation
      run: |
        echo "ğŸ“Š éªŒè¯PDFæ–‡ä»¶..."
        # æ£€æŸ¥ä¸»PDFæˆ–å¤‡ç”¨PDF
        if [ -f "_output/javascript-guide.pdf" ]; then
          PDF_FILE="_output/javascript-guide.pdf"
        elif [ -f "_output/javascript-guide-simple.pdf" ]; then
          PDF_FILE="_output/javascript-guide-simple.pdf"
        else
          echo "âŒ æ²¡æœ‰æ‰¾åˆ°PDFæ–‡ä»¶"
          exit 1
        fi
        
        PDF_SIZE=$(stat -c%s "$PDF_FILE")
        echo "PDF æ–‡ä»¶å¤§å°: $PDF_SIZE å­—èŠ‚ ($(echo "scale=2; $PDF_SIZE/1024/1024" | bc) MB)"
        
        if command -v pdfinfo >/dev/null 2>&1; then
          echo "ğŸ“„ PDF ä¿¡æ¯:"
          pdfinfo "$PDF_FILE" || echo "æ— æ³•è¯»å–PDFè¯¦ç»†ä¿¡æ¯"
        fi
        
        if [ "$PDF_SIZE" -lt 102400 ]; then
          echo "âš ï¸  è­¦å‘Š: PDF æ–‡ä»¶å¯èƒ½å¤ªå°ï¼Œå†…å®¹å¯èƒ½ä¸å®Œæ•´"
          exit 1
        else
          echo "âœ… PDF æ–‡ä»¶å¤§å°æ­£å¸¸"
        fi

    - name: Upload PDF Artifact
      uses: actions/upload-artifact@v4
      with:
        name: JavaScript-Guide-PDF
        path: |
          _output/javascript-guide.pdf
          _output/javascript-guide-simple.pdf
        retention-days: 30
