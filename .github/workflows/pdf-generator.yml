name: Generate PDF from Markdown

on:
  push:
    branches: [main, master]
  workflow_dispatch:  # å…è®¸æ‰‹åŠ¨è§¦å‘

jobs:
  generate-pdf:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout Code
      uses: actions/checkout@v4
      with:
        submodules: recursive
        fetch-depth: 0

    - name: Setup Environment
      run: |
        mkdir -p _output _temp
        echo "å·¥ä½œç›®å½•: $(pwd)"
        echo "æ–‡ä»¶åˆ—è¡¨:"
        find . -name "*.md" -type f | head -10

    - name: Install Dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          pandoc \
          texlive-xetex \
          texlive-latex-recommended \
          texlive-latex-extra \
          texlive-fonts-recommended \
          texlive-fonts-extra \
          texlive-science \
          texlive-pictures \
          lmodern \
          fonts-noto-cjk \
          fonts-noto-color-emoji

    - name: Check Markdown Files
      id: check_files
      run: |
        # ç¡®å®šå…¥å£æ–‡ä»¶
        if [ -f "README.md" ]; then
          ENTRY_FILE="README.md"
        elif [ -f "main.md" ]; then
          ENTRY_FILE="main.md"
        elif [ -f "index.md" ]; then
          ENTRY_FILE="index.md"
        else
          ENTRY_FILE=$(find . -name "*.md" -type f | head -1)
        fi
        
        if [ -z "$ENTRY_FILE" ]; then
          echo "âŒ æœªæ‰¾åˆ°ä»»ä½• Markdown æ–‡ä»¶"
          exit 1
        fi
        
        echo "ğŸ“– ä½¿ç”¨å…¥å£æ–‡ä»¶: $ENTRY_FILE"
        echo "entry_file=$ENTRY_FILE" >> $GITHUB_OUTPUT
        
        # è®°å½•æ‰¾åˆ°çš„æ‰€æœ‰ Markdown æ–‡ä»¶
        find . -name "*.md" -type f \
          ! -path "./.git/*" \
          ! -path "./node_modules/*" \
          ! -path "./_output/*" \
          ! -path "./_temp/*" > _temp/all_markdown_files.txt
        
        echo "ğŸ“‹ æ‰¾åˆ°çš„ Markdown æ–‡ä»¶:"
        cat _temp/all_markdown_files.txt

    - name: Create LaTeX Header File
      run: |
        # åˆ›å»ºåŒ…å«å®Œæ•´LaTeXæ ·å¼çš„headeræ–‡ä»¶
        cat > _temp/header.tex << 'EOFEND'
        \usepackage{titlesec}
        \usepackage{fancyhdr}
        \usepackage{xcolor}
        \usepackage{hyperref}
        
        % ç« èŠ‚æ ‡é¢˜æ ·å¼
        \titleformat{\chapter}[display]
          {\normalfont\huge\bfseries\color{blue!70!black}}
          {\chaptertitlename\ \thechapter}{20pt}{\Huge}
        
        \titleformat{\section}
          {\normalfont\Large\bfseries\color{blue!60!black}}
          {\thesection}{1em}{}
        
        \titleformat{\subsection}
          {\normalfont\large\bfseries\color{blue!50!black}}
          {\thesubsection}{1em}{}
        
        % é¡µçœ‰é¡µè„šè®¾ç½®
        \pagestyle{fancy}
        \fancyhf{}
        \fancyhead[L]{\leftmark}
        \fancyhead[R]{\thepage}
        \renewcommand{\headrulewidth}{0.5pt}
        
        % è¶…é“¾æ¥è®¾ç½®
        \hypersetup{
          pdfauthor={Richard-Billyham},
          pdftitle={JavaScriptæƒå¨æŒ‡å—ç¬¬ä¸ƒç‰ˆ},
          pdfsubject={JavaScriptç¼–ç¨‹æŒ‡å—},
          pdfkeywords={JavaScript,ç¼–ç¨‹,æŒ‡å—},
          bookmarksnumbered=true,
          bookmarksopen=true,
          pdfstartview=FitH
        }
        
        % ä»£ç å—æ”¯æŒ
        \usepackage{listings}
        \lstset{
          basicstyle=\ttfamily\small,
          breaklines=true,
          frame=single,
          backgroundcolor=\color{gray!5}
        }
        EOFEND
        
        # éªŒè¯æ–‡ä»¶åˆ›å»ºæˆåŠŸ
        echo "âœ… LaTeX header æ–‡ä»¶å·²åˆ›å»º:"
        ls -la _temp/header.tex
        echo "æ–‡ä»¶å†…å®¹é¢„è§ˆ:"
        head -10 _temp/header.tex

    - name: Generate PDF with Enhanced Styling
      run: |
        ENTRY_FILE="${{ steps.check_files.outputs.entry_file }}"
        WORKSPACE_PATH="${{ github.workspace }}"
        
        echo "ğŸ¯ å¼€å§‹ç”ŸæˆPDF..."
        echo "å…¥å£æ–‡ä»¶: $ENTRY_FILE"
        echo "å·¥ä½œç›®å½•: $WORKSPACE_PATH"
        echo "Headeræ–‡ä»¶è·¯å¾„: $WORKSPACE_PATH/_temp/header.tex"
        
        # æ£€æŸ¥headeræ–‡ä»¶æ˜¯å¦å­˜åœ¨
        if [ ! -f "_temp/header.tex" ]; then
          echo "âŒ Headeræ–‡ä»¶ä¸å­˜åœ¨ï¼Œé‡æ–°åˆ›å»º..."
          mkdir -p _temp
          echo "\\usepackage{hyperref}" > _temp/header.tex
        fi
        
        # ä½¿ç”¨Pandocç”ŸæˆPDFï¼Œç¡®ä¿ä½¿ç”¨å®Œæ•´è·¯å¾„
        pandoc "$ENTRY_FILE" -o "_output/JavaScriptæƒå¨æŒ‡å—.pdf" \
          --metadata title="JavaScriptæƒå¨æŒ‡å—ç¬¬ä¸ƒç‰ˆ" \
          --metadata author="Richard-Billyham" \
          --table-of-contents \
          --toc-depth=3 \
          --number-sections \
          --pdf-engine=xelatex \
          -V mainfont="Noto Sans CJK SC" \
          -V sansfont="Noto Sans CJK SC" \
          -V monofont="Noto Sans Mono CJK SC" \
          -V geometry:margin=2.5cm \
          -V geometry:a4paper \
          -V colorlinks=true \
          -V linkcolor=blue \
          -V urlcolor=cyan \
          -V toccolor=blue \
          -V papersize=a4 \
          -V fontsize=11pt \
          -V linestretch=1.2 \
          --include-in-header="$WORKSPACE_PATH/_temp/header.tex" \
          --highlight-style=tango
        
        echo "âœ… PDFç”Ÿæˆå‘½ä»¤æ‰§è¡Œå®Œæˆ"

    - name: Verify PDF Generation
      run: |
        if [ ! -f "_output/JavaScriptæƒå¨æŒ‡å—.pdf" ]; then
          echo "âŒ PDF æ–‡ä»¶ç”Ÿæˆå¤±è´¥"
          echo "å½“å‰ç›®å½•å†…å®¹:"
          ls -la
          echo "_output ç›®å½•å†…å®¹:"
          ls -la _output/ || echo "_output ç›®å½•ä¸å­˜åœ¨"
          exit 1
        else
          echo "âœ… PDF æ–‡ä»¶ç”ŸæˆæˆåŠŸ"
          echo "æ–‡ä»¶ä¿¡æ¯:"
          ls -la "_output/JavaScriptæƒå¨æŒ‡å—.pdf"
          # å°è¯•è·å–PDFåŸºæœ¬ä¿¡æ¯
          if command -v pdfinfo &> /dev/null; then
            sudo apt-get install -y poppler-utils
            pdfinfo "_output/JavaScriptæƒå¨æŒ‡å—.pdf" || echo "æ— æ³•è¯»å–PDFä¿¡æ¯"
          fi
        fi

    - name: Upload PDF Artifact
      uses: actions/upload-artifact@v4
      with:
        name: JavaScriptæƒå¨æŒ‡å—
        path: _output/JavaScriptæƒå¨æŒ‡å—.pdf
        retention-days: 30

    - name: Upload to GitHub Releases (Optional)
      if: startsWith(github.ref, 'refs/tags/')
      uses: softprops/action-gh-release@v1
      with:
        files: _output/JavaScriptæƒå¨æŒ‡å—.pdf
