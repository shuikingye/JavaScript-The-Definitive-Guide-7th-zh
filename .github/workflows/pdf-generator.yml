name: Generate PDF from Markdown

on:
  push:
    branches: [main, master]
  workflow_dispatch:

jobs:
  generate-pdf:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout Code
      uses: actions/checkout@v4
      with:
        submodules: recursive
        fetch-depth: 0

    - name: Setup Environment
      run: |
        echo "ğŸ“ è®¾ç½®å·¥ä½œç¯å¢ƒ..."
        mkdir -p _output _temp
        echo "å½“å‰ç›®å½•: $(pwd)"
        echo "ç›®å½•å†…å®¹:"
        ls -la
        echo "Markdown æ–‡ä»¶:"
        find . -name "*.md" -type f | head -20

    - name: Install Dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          pandoc \
          texlive-xetex \
          texlive-latex-recommended \
          texlive-fonts-recommended \
          fonts-noto-cjk \
          fonts-noto-color-emoji \
          poppler-utils

    - name: Create Complete Markdown File
      id: create_md
      run: |
        echo "ğŸ“ åˆ›å»ºå®Œæ•´çš„Markdownæ–‡ä»¶..."
        
        # ç¡®ä¿_tempç›®å½•å­˜åœ¨
        mkdir -p _temp
        
        # åˆ›å»ºåŸºç¡€æ–‡ä»¶
        echo "# JavaScriptæƒå¨æŒ‡å—ç¬¬ä¸ƒç‰ˆ" > _temp/complete.md
        echo "" >> _temp/complete.md
        echo "**ä½œè€…: Richard-Billyham**" >> _temp/complete.md
        echo "" >> _temp/complete.md
        echo "***" >> _temp/complete.md
        echo "" >> _temp/complete.md
        
        # æ·»åŠ README.md
        if [ -f "README.md" ]; then
          echo "æ·»åŠ  README.md"
          cat "README.md" >> _temp/complete.md
          echo "" >> _temp/complete.md
          echo "\\newpage" >> _temp/complete.md
          echo "" >> _temp/complete.md
        else
          echo "âš ï¸  README.md ä¸å­˜åœ¨"
        fi
        
        # æŸ¥æ‰¾å¹¶æ·»åŠ å…¶ä»–markdownæ–‡ä»¶
        echo "æŸ¥æ‰¾å…¶ä»–Markdownæ–‡ä»¶..."
        find . -name "*.md" -type f \
          ! -path "./.git/*" \
          ! -path "./node_modules/*" \
          ! -path "./_output/*" \
          ! -path "./_temp/*" \
          ! -name "README.md" \
          ! -name "CONTRIBUTING.md" \
          ! -name "CHANGELOG.md" > _temp/file_list.txt
        
        if [ -s "_temp/file_list.txt" ]; then
          echo "æ‰¾åˆ°ä»¥ä¸‹æ–‡ä»¶:"
          cat _temp/file_list.txt
          
          # æŒ‰æ•°å­—æ’åº
          sort -V _temp/file_list.txt > _temp/sorted_files.txt
          
          while IFS= read -r file; do
            if [ -f "$file" ]; then
              echo "æ·»åŠ : $file"
              echo "# $(basename "$file" .md)" >> _temp/complete.md
              echo "" >> _temp/complete.md
              cat "$file" >> _temp/complete.md
              echo "" >> _temp/complete.md
              echo "\\newpage" >> _temp/complete.md
              echo "" >> _temp/complete.md
            fi
          done < _temp/sorted_files.txt
        else
          echo "âš ï¸  æ²¡æœ‰æ‰¾åˆ°å…¶ä»–Markdownæ–‡ä»¶"
        fi
        
        # éªŒè¯æ–‡ä»¶åˆ›å»º
        if [ ! -f "_temp/complete.md" ]; then
          echo "âŒ æœªèƒ½åˆ›å»º _temp/complete.md"
          exit 1
        fi
        
        echo "âœ… æ–‡ä»¶åˆ›å»ºæˆåŠŸ"
        echo "æ–‡ä»¶å¤§å°: $(ls -lh _temp/complete.md)"
        echo "è¡Œæ•°: $(wc -l < _temp/complete.md)"

    - name: Method 1 - Simple Pandoc
      run: |
        echo "ğŸ¯ æ–¹æ³•1: ç®€å•Pandocè½¬æ¢..."
        
        if [ ! -f "_temp/complete.md" ]; then
          echo "âŒ _temp/complete.md ä¸å­˜åœ¨"
          exit 1
        fi
        
        # æœ€ç®€å•çš„pandocå‘½ä»¤
        pandoc "_temp/complete.md" -o "_output/method1-simple.pdf" \
          --pdf-engine=xelatex \
          -V mainfont="Noto Sans CJK SC" \
          -V geometry:margin=2.5cm \
          -V papersize=a4 \
          --table-of-contents \
          --toc-depth=2
        
        echo "âœ… æ–¹æ³•1å®Œæˆ"

    - name: Method 2 - With Metadata
      run: |
        echo "ğŸ¯ æ–¹æ³•2: å¸¦å…ƒæ•°æ®çš„è½¬æ¢..."
        
        if [ ! -f "_temp/complete.md" ]; then
          echo "âŒ _temp/complete.md ä¸å­˜åœ¨"
          exit 1
        fi
        
        pandoc "_temp/complete.md" -o "_output/method2-with-metadata.pdf" \
          --pdf-engine=xelatex \
          -V mainfont="Noto Sans CJK SC" \
          -V geometry:margin=2.5cm \
          -V papersize=a4 \
          -V fontsize=12pt \
          --table-of-contents \
          --toc-depth=3 \
          -M title="JavaScriptæƒå¨æŒ‡å—ç¬¬ä¸ƒç‰ˆ" \
          -M author="Richard-Billyham"
        
        echo "âœ… æ–¹æ³•2å®Œæˆ"

    - name: Method 3 - Escape Special Characters
      run: |
        echo "ğŸ¯ æ–¹æ³•3: è½¬ä¹‰ç‰¹æ®Šå­—ç¬¦..."
        
        if [ ! -f "_temp/complete.md" ]; then
          echo "âŒ _temp/complete.md ä¸å­˜åœ¨"
          exit 1
        fi
        
        # åˆ›å»ºè½¬ä¹‰ç‰ˆæœ¬
        cp "_temp/complete.md" "_temp/complete_escaped.md"
        
        # è½¬ä¹‰åæ–œæ ï¼ˆä¸»è¦é—®é¢˜ï¼‰
        sed -i 's/\\/\\\\/g' "_temp/complete_escaped.md"
        
        # è½¬ä¹‰å…¶ä»–LaTeXç‰¹æ®Šå­—ç¬¦
        sed -i 's/#/\\#/g' "_temp/complete_escaped.md"
        sed -i 's/\$/\\$/g' "_temp/complete_escaped.md"
        sed -i 's/%/\\%/g' "_temp/complete_escaped.md"
        sed -i 's/&/\\&/g' "_temp/complete_escaped.md"
        sed -i 's/_/\\_/g' "_temp/complete_escaped.md"
        
        pandoc "_temp/complete_escaped.md" -o "_output/method3-escaped.pdf" \
          --pdf-engine=xelatex \
          -V mainfont="Noto Sans CJK SC" \
          -V geometry:margin=2.5cm \
          -V papersize=a4 \
          --table-of-contents
        
        echo "âœ… æ–¹æ³•3å®Œæˆ"

    - name: Method 4 - Use Listings for Code
      run: |
        echo "ğŸ¯ æ–¹æ³•4: ä½¿ç”¨listingså¤„ç†ä»£ç ..."
        
        if [ ! -f "_temp/complete.md" ]; then
          echo "âŒ _temp/complete.md ä¸å­˜åœ¨"
          exit 1
        fi
        
        # åˆ›å»ºç®€å•çš„LaTeXå¤´æ–‡ä»¶
        mkdir -p _temp
        cat > _temp/header.tex << 'EOF'
        \usepackage{listings}
        \usepackage{xcolor}
        
        \lstset{
          basicstyle=\ttfamily\small,
          breaklines=true,
          frame=single,
          backgroundcolor=\color{gray!5},
          numbers=left
        }
        EOF
        
        pandoc "_temp/complete.md" -o "_output/method4-listings.pdf" \
          --pdf-engine=xelatex \
          -V mainfont="Noto Sans CJK SC" \
          -V geometry:margin=2.5cm \
          -V papersize=a4 \
          --table-of-contents \
          --listings \
          --include-in-header="${{ github.workspace }}/_temp/header.tex"
        
        echo "âœ… æ–¹æ³•4å®Œæˆ"

    - name: Method 5 - Minimal Approach
      run: |
        echo "ğŸ¯ æ–¹æ³•5: æœ€å°åŒ–æ–¹æ³•..."
        
        if [ ! -f "_temp/complete.md" ]; then
          echo "âŒ _temp/complete.md ä¸å­˜åœ¨"
          exit 1
        fi
        
        # åªè½¬æ¢å‰Nè¡Œæ¥æµ‹è¯•
        head -n 5000 "_temp/complete.md" > "_temp/minimal_test.md"
        
        pandoc "_temp/minimal_test.md" -o "_output/method5-minimal.pdf" \
          --pdf-engine=xelatex \
          -V mainfont="Noto Sans CJK SC" \
          -V geometry:margin=2.5cm
        
        echo "âœ… æ–¹æ³•5å®Œæˆ"

    - name: Verify Results
      run: |
        echo "ğŸ“Š éªŒè¯ç”Ÿæˆç»“æœ..."
        
        # æ£€æŸ¥_outputç›®å½•
        echo "è¾“å‡ºç›®å½•å†…å®¹:"
        ls -la _output/ || echo "è¾“å‡ºç›®å½•ä¸å­˜åœ¨"
        
        # æ£€æŸ¥ç”Ÿæˆçš„PDFæ–‡ä»¶
        shopt -s nullglob
        pdf_count=0
        for pdf in _output/*.pdf; do
          if [ -f "$pdf" ]; then
            size=$(stat -c%s "$pdf")
            echo "âœ… æ‰¾åˆ°: $pdf ($((size/1024)) KB)"
            pdf_count=$((pdf_count+1))
          fi
        done
        
        if [ $pdf_count -eq 0 ]; then
          echo "âŒ æ²¡æœ‰ç”Ÿæˆä»»ä½•PDFæ–‡ä»¶"
          echo "è°ƒè¯•ä¿¡æ¯:"
          echo "å·¥ä½œç›®å½•: $(pwd)"
          echo "_tempç›®å½•å†…å®¹:"
          ls -la _temp/ || echo "_tempç›®å½•ä¸å­˜åœ¨"
          echo "complete.mdå‰10è¡Œ:"
          head -10 _temp/complete.md || echo "æ— æ³•è¯»å–complete.md"
          exit 1
        else
          echo "ğŸ‰ æˆåŠŸç”Ÿæˆ $pdf_count ä¸ªPDFæ–‡ä»¶"
        fi

    - name: Upload PDF Artifacts
      uses: actions/upload-artifact@v4
      with:
        name: Generated-PDFs
        path: _output/*.pdf
        retention-days: 30

    - name: Upload Debug Info
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: Debug-Info
        path: |
          _temp/
        retention-days: 7
